!function(){JailedSite=function(connection){this._interface={},this._remote=null,this._remoteUpdateHandler=function(){},this._getInterfaceHandler=function(){},this._interfaceSetAsRemoteHandler=function(){},this._disconnectHandler=function(){},this._store=new ReferenceStore;var me=this;this._connection=connection,this._connection.onMessage(function(data){me._processMessage(data)}),this._connection.onDisconnect(function(m){me._disconnectHandler(m)})},JailedSite.prototype.onRemoteUpdate=function(handler){this._remoteUpdateHandler=handler},JailedSite.prototype.onInterfaceSetAsRemote=function(handler){this._interfaceSetAsRemoteHandler=handler},JailedSite.prototype.onGetInterface=function(handler){this._getInterfaceHandler=handler},JailedSite.prototype.getRemote=function(){return this._remote},JailedSite.prototype.setInterface=function(_interface){this._interface=_interface,this._sendInterface()},JailedSite.prototype._sendInterface=function(){var names=[];for(var name in this._interface)this._interface.hasOwnProperty(name)&&names.push(name);this._connection.send({type:"setInterface",api:names})},JailedSite.prototype._processMessage=function(data){switch(data.type){case"method":var method=this._interface[data.name],args=this._unwrap(data.args);method.apply(null,args);break;case"callback":var method=this._store.fetch(data.id)[data.num],args=this._unwrap(data.args);method.apply(null,args);break;case"setInterface":this._setRemote(data.api);break;case"getInterface":this._sendInterface(),this._getInterfaceHandler();break;case"interfaceSetAsRemote":this._interfaceSetAsRemoteHandler();break;case"disconnect":this._disconnectHandler(),this._connection.disconnect()}},JailedSite.prototype.requestRemote=function(){this._connection.send({type:"getInterface"})},JailedSite.prototype._setRemote=function(names){this._remote={};var i,name;for(i=0;i<names.length;i++)name=names[i],this._remote[name]=this._genRemoteMethod(name);this._remoteUpdateHandler(),this._reportRemoteSet()},JailedSite.prototype._genRemoteMethod=function(name){var me=this;return function(){me._connection.send({type:"method",name:name,args:me._wrap(arguments)})}},JailedSite.prototype._reportRemoteSet=function(){this._connection.send({type:"interfaceSetAsRemote"})},JailedSite.prototype._wrap=function(args){for(var wrapped=[],callbacks={},callbacksPresent=!1,i=0;i<args.length;i++)"function"==typeof args[i]?(callbacks[i]=args[i],wrapped[i]={type:"callback",num:i},callbacksPresent=!0):wrapped[i]={type:"argument",value:args[i]};var result={args:wrapped};return callbacksPresent&&(result.callbackId=this._store.put(callbacks)),result},JailedSite.prototype._unwrap=function(args){var i,arg,cb,called=!1,result=[];for(i=0;i<args.args.length;i++)arg=args.args[i],"argument"==arg.type?result.push(arg.value):(cb=function(cb){return function(){if(called){throw new Error("A callback from this set has already been executed")}called=!0,cb.apply(this,arguments)}}(this._genRemoteCallback(args.callbackId,i)),result.push(cb));return result},JailedSite.prototype._genRemoteCallback=function(id,argNum){var me=this;return function(){me._connection.send({type:"callback",id:id,num:argNum,args:me._wrap(arguments)})}},JailedSite.prototype.disconnect=function(){this._connection.send({type:"disconnect"}),this._connection.disconnect()},JailedSite.prototype.onDisconnect=function(handler){this._disconnectHandler=handler};var ReferenceStore=function(){this._store={},this._indices=[0]};ReferenceStore.prototype._genId=function(){return 1==this._indices.length?this._indices[0]++:this._indices.shift()},ReferenceStore.prototype._releaseId=function(id){for(var i=0;i<this._indices.length;i++)if(id<this._indices[i]){this._indices.splice(i,0,id);break}for(i=this._indices.length-1;i>=0&&this._indices[i]-1==this._indices[i-1];i--)this._indices.pop()},ReferenceStore.prototype.put=function(obj){var id=this._genId();return this._store[id]=obj,id},ReferenceStore.prototype.fetch=function(id){var obj=this._store[id];return this._store[id]=null,delete this._store[id],this._releaseId(id),obj}}();