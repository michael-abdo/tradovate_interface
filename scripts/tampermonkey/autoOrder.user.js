// ==UserScript==
// @name         Auto Order (Modular)
// @namespace    http://tampermonkey.net/
// @version      6.0
// @description  Thin wrapper that loads the modular Tradovate automation driver and UI panel.
// @author       You
// @match        https://trader.tradovate.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=tradovate.com
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    const driverSource = "var TradovateAutoDriverBundle=(()=>{var X=Object.defineProperty;var ye=Object.getOwnPropertyDescriptor;var me=Object.getOwnPropertyNames;var be=Object.prototype.hasOwnProperty;var fe=(L,k)=>{for(var A in k)X(L,A,{get:k[A],enumerable:!0})},xe=(L,k,A,q)=>{if(k&&typeof k==\"object\"||typeof k==\"function\")for(let M of me(k))!be.call(L,M)&&M!==A&&X(L,M,{get:()=>k[M],enumerable:!(q=ye(k,M))||q.enumerable});return L};var ke=L=>xe(X({},\"__esModule\",{value:!0}),L);var Ie={};fe(Ie,{createAutoDriver:()=>ve,default:()=>Se});(function(){\"use strict\";console.log(\"Auto Order script initialized\");var L=!1;function k(t){return console.log(`Delaying for ${t}ms`),new Promise(n=>setTimeout(n,t))}function A(){console.log(\"Creating UI\");let t=localStorage.getItem(\"bracketTrade_tp\")||\"120\",n=localStorage.getItem(\"bracketTrade_sl\")||\"40\",l=localStorage.getItem(\"bracketTrade_qty\")||\"9\",i=localStorage.getItem(\"bracketTrade_tick\")||\"0.25\",y=localStorage.getItem(\"bracketTrade_symbol\")||\"NQ\";console.log(`Stored values: TP=${t}, SL=${n}, Qty=${l}, Tick=${i}, Symbol=${y}`);let a=document.createElement(\"div\");a.id=\"bracket-trade-box\",Object.assign(a.style,{position:\"fixed\",background:\"#1e1e1e\",border:\"1px solid #444\",padding:\"12px\",zIndex:\"99999\",boxShadow:\"0 2px 10px rgba(0,0,0,0.5)\",borderRadius:\"8px\",color:\"#fff\",cursor:\"move\",fontFamily:\"sans-serif\",textAlign:\"center\",width:\"200px\"});let m=0,f=0;m&&f?(a.style.left=m,a.style.top=f):(a.style.top=\"20px\",a.style.right=\"20px\"),a.innerHTML=`\n    <!-- Header with Symbol -->\n    <div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;\">\n        <span style=\"font-weight:bold;cursor:grab;\">\\u283F Bracket</span>\n        <input type=\"text\" id=\"symbolInput\" value=\"${y}\"\n            style=\"width:50%;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\"\n            placeholder=\"Symbol\" />\n    </div>\n\n    <!-- Hidden Tick Size Input -->\n    <div id=\"tickContainer\" style=\"display:none;margin-bottom:8px;\">\n        <label style=\"display:block;margin-bottom:4px;font-size:11px;\">Tick Size</label>\n        <input type=\"number\" id=\"tickInput\" step=\"0.01\" value=\"${i}\"\n            style=\"width:100%;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\" />\n    </div>\n\n    <!-- Main Controls -->\n    <div id=\"mainControls\">\n        <div style=\"display:flex;align-items:center;gap:8px;margin-bottom:8px;\">\n            <input type=\"checkbox\" id=\"tpCheckbox\" checked />\n            <div style=\"display:flex;gap:4px;flex:1;\">\n                <input type=\"number\" id=\"tpInput\" value=\"${t}\" step=\"1\"\n                    style=\"width:50%;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\"\n                    placeholder=\"TP Ticks\" />\n                <input type=\"number\" id=\"tpPriceInput\" step=\"0.01\"\n                    style=\"width:50%;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\"\n                    placeholder=\"TP Price\" />\n            </div>\n        </div>\n        <div style=\"display:flex;align-items:center;gap:8px;margin-bottom:12px;\">\n            <input type=\"checkbox\" id=\"slCheckbox\" checked />\n            <div style=\"display:flex;gap:4px;flex:1;\">\n                <input type=\"number\" id=\"slInput\" value=\"${n}\" step=\"1\"\n                    style=\"width:50%;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\"\n                    placeholder=\"SL Ticks\" />\n                <input type=\"number\" id=\"slPriceInput\" step=\"0.01\"\n                    style=\"width:50%;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\"\n                    placeholder=\"SL Price\" />\n            </div>\n        </div>\n        <div style=\"display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:12px;\">\n            <button id=\"buyBtn\"  style=\"padding:6px 10px;background:#2ecc71;color:#fff;border:none;border-radius:4px;font-weight:bold;\">Buy</button>\n            <div style=\"display:flex;flex-direction:column;gap:4px;\">\n                <input type=\"number\" id=\"entryPriceInput\" placeholder=\"Entry\" step=\"1\"\n                    style=\"width:80px;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\" />\n                <input type=\"number\" id=\"qtyInput\" value=\"${l}\" min=\"1\"\n                    style=\"width:80px;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\" />\n            </div>\n            <button id=\"sellBtn\" style=\"padding:6px 10px;background:#e74c3c;color:#fff;border:none;border-radius:4px;font-weight:bold;\">Sell</button>\n        </div>\n        <div style=\"display:flex;gap:10px;margin-bottom:2px;\">\n            <button id=\"cancelAllBtn\" style=\"flex:1;padding:12px 8px;background:#e6b800;color:#000;border:none;border-radius:4px;font-weight:bold;\">Cancel</button>\n            <button id=\"closeAllBtn\" style=\"flex:3;padding:12px 8px;background:#e74c3c;color:#fff;border:none;border-radius:4px;font-weight:bold;\">Close All</button>\n        </div>\n\n        <!-- NEW: Breakeven button above Reverse -->\n        <div style=\"display:flex;gap:10px;margin-top:6px;\">\n            <button id=\"breakevenBtn\" style=\"flex:1;padding:12px 8px;background:#6c5ce7;color:#fff;border:none;border-radius:4px;font-weight:bold;\">Breakeven</button>\n        </div>\n\n        <div style=\"display:flex;gap:10px;margin-top:6px;\">\n            <button id=\"reverseBtn\" style=\"flex:1;padding:12px 8px;background:#ff6600;color:#fff;border:none;border-radius:4px;font-weight:bold;\">Reverse</button>\n        </div>\n    </div>`,document.body.appendChild(a),console.log(\"UI container added to DOM\");let o=document.createElement(\"div\");o.id=\"bracket-trade-tray\",Object.assign(o.style,{position:\"fixed\",top:a.style.top||\"20px\",left:\"0px\",background:\"#24262b\",border:\"1px solid #444\",padding:\"10px\",borderRadius:\"8px\",boxShadow:\"0 2px 10px rgba(0,0,0,0.4)\",color:\"#fff\",width:\"140px\",zIndex:\"99999\",display:\"none\"}),o.innerHTML=`\n      <div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;\">\n        <div style=\"font-weight:600;\">Price Tray</div>\n        <button id=\"trayCloseBtn\" title=\"Hide\"\n          style=\"background:#333;border:1px solid #555;color:#fff;border-radius:4px;padding:2px 6px;cursor:pointer;\">\\xD7</button>\n      </div>\n      <div style=\"display:flex;flex-direction:column;gap:6px\">\n        <button id=\"tray-btn-high\"  style=\"padding:6px;border:1px solid #555;background:#2a2d34;color:#fff;border-radius:6px;text-align:left;\">High</button>\n        <button id=\"tray-btn-low\"   style=\"padding:6px;border:1px solid #555;background:#2a2d34;color:#fff;border-radius:6px;text-align:left;\">Low</button>\n        <button id=\"tray-btn-open\"  style=\"padding:6px;border:1px solid #555;background:#2a2d34;color:#fff;border-radius:6px;text-align:left;\">Open</button>\n        <button id=\"tray-btn-close\" style=\"padding:6px;border:1px solid #555;background:#2a2d34;color:#fff;border-radius:6px;text-align:left;\">Close</button>\n        <button id=\"tray-btn-mid\"   style=\"padding:6px;border:1px solid #555;background:#2a2d34;color:#fff;border-radius:6px;text-align:left;\">Middle</button>\n      </div>\n    `,document.body.appendChild(o);let s=document.createElement(\"button\");s.id=\"trayToggle\",s.textContent=\"\\u25C2 O/L/H/C/M\",Object.assign(s.style,{position:\"absolute\",right:\"-92px\",top:\"0\",height:\"32px\",background:\"#30343b\",color:\"#fff\",border:\"1px solid #444\",borderRadius:\"0 8px 8px 0\",padding:\"4px 8px\",cursor:\"pointer\"}),a.appendChild(s);function g(){let e=a.getBoundingClientRect();o.style.top=`${e.top}px`,o.style.left=`${e.right+8}px`}g(),window.addEventListener(\"resize\",g),s.addEventListener(\"click\",()=>{g(),o.style.display=o.style.display===\"none\"?\"block\":\"none\"}),o.querySelector(\"#trayCloseBtn\")?.addEventListener(\"click\",()=>{o.style.display=\"none\"});let r=null;function v(){let e=(document.getElementById(\"tickInput\")?.value||\"\").toString(),d=e.indexOf(\".\");return d===-1?0:e.length-d-1}setInterval(()=>{try{if(typeof M==\"function\"){if(r=M(),r){let e={open:[\"tray-btn-open\",\"Open\"],low:[\"tray-btn-low\",\"Low\"],high:[\"tray-btn-high\",\"High\"],close:[\"tray-btn-close\",\"Close\"]};for(let[c,[u,b]]of Object.entries(e)){let w=document.getElementById(u);if(!w)continue;let $=r[c];w.title=$!=null?`${b}: ${$}`:`${b}: \\u2014`}let d=document.getElementById(\"tray-btn-mid\");if(d){let c=r.open,u=r.close;if(typeof c==\"number\"&&typeof u==\"number\"){let b=v(),w=((c+u)/2).toFixed(b);d.title=`Mid (O+C)/2: ${w}`}else d.title=\"Mid (O+C)/2: \\u2014\"}}g()}}catch(e){console.warn(\"extractTradovateDataBox polling error:\",e)}},500);function x(e){let d=document.getElementById(\"entryPriceInput\");if(!d||e==null)return;Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,\"value\").set.call(d,e),[\"input\",\"change\",\"blur\"].forEach(u=>d.dispatchEvent(new Event(u,{bubbles:!0})))}function p(e){if(!r||r[e]==null){console.warn(`No ${e} available from databox`);return}x(r[e])}function S(){if(!r||typeof r.open!=\"number\"||typeof r.close!=\"number\"){console.warn(\"Mid price unavailable (need open & close)\");return}let e=v(),d=((r.high+r.low)/2).toFixed(e);x(d)}document.getElementById(\"tray-btn-open\")?.addEventListener(\"click\",()=>p(\"open\")),document.getElementById(\"tray-btn-low\")?.addEventListener(\"click\",()=>p(\"low\")),document.getElementById(\"tray-btn-high\")?.addEventListener(\"click\",()=>p(\"high\")),document.getElementById(\"tray-btn-close\")?.addEventListener(\"click\",()=>p(\"close\")),document.getElementById(\"tray-btn-mid\")?.addEventListener(\"click\",S),console.log(\"Setting up UI event handlers\");let I=document.getElementById(\"slInput\"),h=document.getElementById(\"tpInput\"),T=document.getElementById(\"qtyInput\");document.getElementById(\"slInput\").addEventListener(\"input\",()=>{console.log(`SL input changed to: ${I.value}`);let e=parseFloat(I.value);isNaN(e)||(h.value=e*3,console.log(`Calculated TP: ${h.value} (SL \\xD7 3)`)),localStorage.setItem(\"bracketTrade_sl\",I.value),localStorage.setItem(\"bracketTrade_tp\",h.value)}),h.addEventListener(\"input\",()=>{console.log(`TP input changed to: ${h.value}`),localStorage.setItem(\"bracketTrade_tp\",h.value)}),document.getElementById(\"qtyInput\").addEventListener(\"input\",e=>{console.log(`Quantity input changed to: ${e.target.value}`),localStorage.setItem(\"bracketTrade_qty\",e.target.value)}),document.getElementById(\"closeAllBtn\").addEventListener(\"click\",()=>{console.log(\"Close All button clicked\");try{let e=document.getElementById(\"symbolInput\").value||\"NQ\",d=O(e);console.log(`Calling clickExitForSymbol for: ${d} with Exit at Mkt & Cxl option`),q(d,\"cancel-option-Exit-at-Mkt-Cxl\"),console.log(\"Exit action triggered for symbol:\",d)}catch(e){console.error(\"Close All operation failed:\",e);try{console.log(\"Attempting fallback close method with danger buttons\"),document.getElementsByClassName(\"btn btn-danger\")[0]?.click(),setTimeout(()=>{document.getElementsByClassName(\"btn btn-danger\")[1]?.click(),document.getElementsByClassName(\"btn btn-danger\")[2]?.click()},200)}catch(d){console.error(\"Fallback close method also failed:\",d)}}}),document.getElementById(\"cancelAllBtn\").addEventListener(\"click\",()=>{console.log(\"Cancel All button clicked\");try{let e=document.getElementById(\"symbolInput\").value||\"NQ\",d=O(e);console.log(`Calling clickExitForSymbol for: ${d} with Cancel All option`),q(d,\"cancel-option-Cancel-All\"),console.log(\"Cancel All action triggered for symbol:\",d)}catch(e){console.error(\"Cancel All operation failed:\",e)}}),document.getElementById(\"reverseBtn\").addEventListener(\"click\",()=>{console.log(\"Reverse Position button clicked\");try{let e=document.getElementById(\"symbolInput\").value||\"NQ\",d=O(e);console.log(`Calling clickExitForSymbol for: ${d} with Reverse & Cxl option`),q(d,\"cancel-option-Reverse-Cxl\"),console.log(\"Reverse Position action triggered for symbol:\",d)}catch(e){console.error(\"Reverse Position operation failed:\",e)}}),document.getElementById(\"breakevenBtn\").addEventListener(\"click\",async()=>{console.log(\"Breakeven button clicked\");try{let e=document.getElementById(\"symbolInput\").value||\"NQ\",d=O(e);console.log(`Breakeven for symbol: ${d}`);let c=C=>(C||\"\").replace(/\\s+/g,\" \").trim().toUpperCase(),u=[...document.querySelectorAll(\".contract-symbol span\")].find(C=>{let z=c(C.textContent),ge=c(d);return z===ge||z.startsWith(c(e))});if(!u)return console.error(\"Breakeven: contract header not found\");let w=[...(u.closest(\".gm-scroll-view\")||u.closest(\".header\")||document).querySelectorAll(\".info-column\")].find(C=>/position/i.test(C.querySelector(\"small\")?.textContent||\"\"));if(!w){console.error(\"Breakeven: Position column not found\");return}let $=w.querySelector(\".number\"),F=$?.querySelector(\"span\"),Z=($?.textContent||\"\").trim().match(/@([\\d.,]+)/);if(!Z){console.error(\"Breakeven: could not parse entry price from Position\");return}let W=parseFloat(Z[1].replace(/,/g,\"\")),V=1;if(F){let C=parseFloat(F.textContent.replace(/[^\\d.-]/g,\"\"));!isNaN(C)&&C!==0&&(V=Math.abs(C))}let H=\"LONG\",J=F?.classList||$?.classList||{contains:()=>!1};J.contains(\"text-danger\")&&(H=\"SHORT\"),J.contains(\"text-success\")&&(H=\"LONG\");let ee=H===\"LONG\"?\"Sell\":\"Buy\";console.log(`Breakeven detected: side=${H}, qty=${V}, entry=${W}. Placing ${ee} LIMIT at entry.`);let j=document.getElementById(\"tpCheckbox\"),K=document.getElementById(\"slCheckbox\"),de=j.checked,ue=K.checked;j.checked=!1,K.checked=!1;let pe=(()=>{let z=(parseFloat(document.getElementById(\"tickInput\").value)||.25).toString();return z.includes(\".\")?z.length-z.indexOf(\".\")-1:0})();document.getElementById(\"entryPriceInput\").value=W.toFixed(pe),document.getElementById(\"qtyInput\").value=V.toString(),[\"input\",\"change\",\"blur\"].forEach(C=>{document.getElementById(\"entryPriceInput\").dispatchEvent(new Event(C,{bubbles:!0})),document.getElementById(\"qtyInput\").dispatchEvent(new Event(C,{bubbles:!0}))}),await N(e,V,ee,null,null,parseFloat(document.getElementById(\"tickInput\").value)||.25),j.checked=de,K.checked=ue,document.getElementById(\"entryPriceInput\").value=\"\",[\"input\",\"change\",\"blur\"].forEach(C=>document.getElementById(\"entryPriceInput\").dispatchEvent(new Event(C,{bubbles:!0})))}catch(e){console.error(\"Breakeven action failed:\",e)}}),console.log(\"Setting up persistent settings\"),document.getElementById(\"symbolInput\").value=localStorage.getItem(\"bracketTrade_symbol\")||\"NQ\",document.getElementById(\"symbolInput\").addEventListener(\"input\",e=>{console.log(`Symbol input changed to: ${e.target.value}`),localStorage.setItem(\"bracketTrade_symbol\",e.target.value)}),document.getElementById(\"symbolInput\").addEventListener(\"change\",e=>{let d=e.target.value,c=O(d);console.log(`Symbol changed to: ${d}, normalized: ${c}`);let u=d.replace(/[A-Z]\\d+$/,\"\"),b=Y[u];if(b){console.log(`Found default values for ${u}: SL=${b.defaultSL}, TP=${b.defaultTP}`);let w=document.getElementById(\"slInput\"),$=document.getElementById(\"tpInput\"),F=document.getElementById(\"tickInput\");w.value=b.defaultSL,$.value=b.defaultTP,typeof b.tickSize==\"number\"&&(F.value=b.tickSize,localStorage.setItem(\"bracketTrade_tick\",b.tickSize),console.log(`Updated tick size to ${b.tickSize} for ${u}`)),localStorage.setItem(\"bracketTrade_sl\",b.defaultSL),localStorage.setItem(\"bracketTrade_tp\",b.defaultTP),console.log(`Updated SL/TP to default values for ${u}: SL=${w.value}, TP=${$.value}`)}te(\".search-box--input\",c)}),document.getElementById(\"tickInput\").value=localStorage.getItem(\"bracketTrade_tick\")||\"0.25\",document.getElementById(\"tickInput\").addEventListener(\"input\",e=>{console.log(`Tick size input changed to: ${e.target.value}`),localStorage.setItem(\"bracketTrade_tick\",e.target.value)}),console.log(\"Setting up drag functionality\");let E=!1,B,P;a.addEventListener(\"mousedown\",e=>{console.log(\"Container mousedown event detected\"),E=!0,B=e.clientX-a.getBoundingClientRect().left,P=e.clientY-a.getBoundingClientRect().top,console.log(`Drag started at offset X:${B}, Y:${P}`),a.style.cursor=\"grabbing\"}),document.addEventListener(\"mousemove\",e=>{if(E){let d=`${e.clientX-B}px`,c=`${e.clientY-P}px`;e.clientX%20===0&&console.log(`Dragging panel to X:${d}, Y:${c}`),a.style.left=d,a.style.top=c,a.style.right=\"unset\",g()}}),document.addEventListener(\"mouseup\",()=>{E&&(console.log(`Container drop position: Left:${a.style.left}, Top:${a.style.top}`),localStorage.setItem(\"bracketTradeBoxLeft\",a.style.left),localStorage.setItem(\"bracketTradeBoxTop\",a.style.top)),E=!1,a.style.cursor=\"grab\"}),console.log(\"Setting up trade buttons\"),document.getElementById(\"buyBtn\").addEventListener(\"click\",()=>{console.log(\"BUY button clicked\");let e=document.getElementById(\"symbolInput\").value||\"NQ\",d=+T.value,c=+h.value,u=+I.value,b=+document.getElementById(\"tickInput\").value;console.log(`Initiating BUY order: Symbol=${e}, Qty=${d}, TP=${c}, SL=${u}, TickSize=${b}`),N(e,d,\"Buy\",c,u,b).finally(()=>{document.getElementById(\"entryPriceInput\").value=\"\",document.getElementById(\"tpPriceInput\").value=\"\",document.getElementById(\"slPriceInput\").value=\"\",console.log(\"Price inputs reset after BUY order\")})}),document.getElementById(\"sellBtn\").addEventListener(\"click\",()=>{console.log(\"SELL button clicked\");let e=document.getElementById(\"symbolInput\").value||\"NQ\",d=+T.value,c=+h.value,u=+I.value,b=+document.getElementById(\"tickInput\").value;console.log(`Initiating SELL order: Symbol=${e}, Qty=${d}, TP=${c}, SL=${u}, TickSize=${b}`),N(e,d,\"Sell\",c,u,b).finally(()=>{document.getElementById(\"entryPriceInput\").value=\"\",document.getElementById(\"tpPriceInput\").value=\"\",document.getElementById(\"slPriceInput\").value=\"\",console.log(\"Price inputs reset after SELL order\")})})}async function q(t,n=\"cancel-option-Exit-at-Mkt-Cxl\"){let l={exit:\"cancel-option-Exit-at-Mkt-Cxl\",reverse:\"cancel-option-Reverse-Cxl\",\"cancel-all\":\"cancel-option-Cancel-All\",\"cancel-bids\":\"cancel-option-Cancel-Bids\",\"cancel-offers\":\"cancel-option-Cancel-Offers\"},i={\"cancel-option-Exit-at-Mkt-Cxl\":/EXIT\\s*AT\\s*MKT/i,\"cancel-option-Reverse-Cxl\":/REVERSE\\s*&\\s*CXL/i,\"cancel-option-Cancel-All\":/CANCEL\\s*ALL/i,\"cancel-option-Cancel-Bids\":/CANCEL\\s*BIDS/i,\"cancel-option-Cancel-Offers\":/CANCEL\\s*OFFERS/i},y=c=>(c||\"\").replace(/[\\u2000-\\u200F\\u2028\\u2029\\u202F\\u00A0]/g,\" \").replace(/\\s+/g,\" \").trim().toUpperCase(),a=c=>new Promise(u=>setTimeout(u,c));async function m(c,{timeout:u=1200,interval:b=50}={}){let w=performance.now();for(;performance.now()-w<u;){let $=c();if($)return $;await a(b)}return null}let f=n.toLowerCase(),o=l[f]||n,s=i[o]||null,g=y(t),r=/^[A-Z]{1,3}$/.test(g),v=[...document.querySelectorAll(\".header .contract-symbol span\")].find(c=>{let u=y(c.textContent);return u===g||r&&u.startsWith(g)});if(!v)return console.error(\"clickExitForSymbol: contract header not found\"),!1;let p=v.closest(\".header\")?.querySelector(\".dropdown.btn-group.btn-split.btn-group-default\"),S=p?.querySelector(\".btn.btn-default:not(.dropdown-toggle)\"),I=p?.querySelector(\".dropdown-toggle.btn.btn-default\");if(!p||!S||!I)return console.error(\"clickExitForSymbol: split button not found\"),!1;if(s?s.test(y(S.textContent)):!1)return S.click(),!0;I.dispatchEvent(new MouseEvent(\"click\",{bubbles:!0}));let T=()=>[...document.querySelectorAll(\".dropdown-menu\")].filter(c=>c.offsetParent!==null||/display\\s*:\\s*block/i.test(c.getAttribute(\"style\")||\"\")||!!c.closest(\".open\")),E=await m(T,{timeout:900,interval:40});if(!E||!E.length)return console.error(\"clickExitForSymbol: dropdown menu not visible\"),!1;let B=I.getBoundingClientRect();E.sort((c,u)=>{let b=c.getBoundingClientRect(),w=u.getBoundingClientRect(),$=Math.hypot(b.left-B.left,b.top-B.bottom),F=Math.hypot(w.left-B.left,w.top-B.bottom);return $-F});let P=E[0],e=document.getElementById(o);if(!e&&s){for(let c of E)if(e=[...c.querySelectorAll('a[role=\"menuitem\"], a, button, li, span')].find(u=>s.test(y(u.textContent))),e){P=c;break}}if(!e)return console.error(\"clickExitForSymbol: desired menu item not found\"),!1;let d=e.tagName?e.matches(\"a,button\")?e:e.querySelector(\"a,button\")||e:e;return[\"mousedown\",\"mouseup\",\"click\"].forEach(c=>d.dispatchEvent(new MouseEvent(c,{bubbles:!0}))),I.click(),await a(120),E=T(),e=document.getElementById(o)||(s?E?.flatMap(c=>[...c.querySelectorAll('a[role=\"menuitem\"], a, button, li, span')]).find(c=>s.test(y(c.textContent))):null),e?([\"mousedown\",\"mouseup\",\"click\"].forEach(c=>(e.querySelector(\"a,button\")||e).dispatchEvent(new MouseEvent(c,{bubbles:!0}))),await a(80),S.click(),!0):(console.error(\"clickExitForSymbol: primary did not update; giving up\"),!1)}function M(t=document){let n=[...t.querySelectorAll(\".databox.react-draggable.react-resizable\")].find(m=>m.offsetParent!==null);if(!n)return null;let y={timestamp:((m,f=n)=>{let o=f.querySelector(m);return o?o.textContent.trim():null})(\".header .title\")||null};return n.querySelectorAll(\".gm-scroll-view .entries li\").forEach(m=>{let f=m.querySelector(\".label\"),o=m.querySelector(\".desc\");if(!f||!o)return;let s=f.cloneNode(!0);s.querySelectorAll(\"span\").forEach(S=>S.remove());let g=(s.textContent||\"\").trim().toLowerCase().replace(/[^a-z0-9]/g,\"\"),r=(o.textContent||\"\").trim(),x={open:\"open\",high:\"high\",low:\"low\",close:\"close\",volume:\"volume\",atr:\"atr\",vwap:\"vwap\",upperband1:\"upperBand1\",lowerband1:\"lowerBand1\",upperband2:\"upperBand2\",lowerband2:\"lowerBand2\"}[g]||g,p=r.replace(/,/g,\"\");x===\"volume\"?p=Number.parseInt(p,10):p=Number.parseFloat(p),y[x]=Number.isNaN(p)?r:p}),y}document.querySelectorAll(\"#bracket-trade-box, #bracket-trade-tray\").forEach(t=>t.remove()),A(),console.log(\"UI creation complete\");async function te(t,n){console.log(`updateSymbol called with selector: \"${t}\", value: \"${n}\"`);let l=document.querySelectorAll(t);console.log(`Found ${l.length} matching inputs`);let i=l[1]||l[0];if(!i){console.error(\"No matching input elements found!\");return}console.log(\"Selected input:\",i);let y=Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,\"value\").set,a=m=>i.dispatchEvent(new KeyboardEvent(m,{key:\"Enter\",code:\"Enter\",keyCode:13,which:13,bubbles:!0,cancelable:!0}));console.log(\"Clearing input field\"),y.call(i,\"\"),i.focus(),i.dispatchEvent(new Event(\"input\",{bubbles:!0})),await k(400),console.log(`Setting input value to: \"${n}\"`),y.call(i,n),i.focus(),i.dispatchEvent(new Event(\"input\",{bubbles:!0})),await k(900),console.log(\"Simulating Enter key press\"),[\"keydown\",\"keypress\",\"keyup\"].forEach(a),i.dispatchEvent(new Event(\"change\",{bubbles:!0})),console.log(\"Symbol update complete\")}async function Ee(t){let n=\"input.form-control\";for(let l=0;l<20;l++){let i=document.querySelector(n);if(i&&i.offsetParent){Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,\"value\").set.call(i,t),[\"input\",\"change\",\"blur\"].forEach(a=>i.dispatchEvent(new Event(a,{bubbles:!0}))),await k(300);return}await k(100)}console.error(\"Price input not found\")}function O(t){console.log(`normalizeSymbol called with: \"${t}\"`);let n=/^[A-Z]{1,3}$/.test(t);console.log(`Is root symbol: ${n}`);let l=n?ne(t):t.toUpperCase();return console.log(`Normalized symbol: \"${l}\"`),l}async function oe(t){console.log(\"Creating bracket orders with data:\",t);let n=document.getElementById(\"tpCheckbox\").checked,l=document.getElementById(\"slCheckbox\").checked;console.log(`TP enabled: ${n}, SL enabled: ${l}`);async function i(o,s){let g=[...document.querySelectorAll(\".trading-ticket\")].find(p=>p.offsetParent);if(!g)return console.error(\"No visible trading ticket\");let r;for(let p=0;p<25&&(r=[...g.querySelectorAll(o)].find(S=>S.offsetParent&&!S.disabled),!r);p++)await k(100);if(!r)return console.error(`No live input for ${o}`);let v=Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,\"value\").set,x=r.closest(\".select-input.combobox\");x&&!r.value&&(x.querySelector(\".btn\")?.click(),await k(150),x.querySelector(\".dropdown-menu li\")?.click(),await k(150));for(let p=0;p<3&&(r.focus(),v.call(r,s),r.dispatchEvent(new Event(\"input\",{bubbles:!0})),r.dispatchEvent(new Event(\"change\",{bubbles:!0})),r.dispatchEvent(new KeyboardEvent(\"keydown\",{key:\"Enter\",code:\"Enter\",keyCode:13,which:13,bubbles:!0})),r.blur(),await k(250),`${r.value}`.trim()!==`${s}`);p++);}async function y(){if(console.log(\"Setting common order fields\"),t.action){console.log(`Setting action to: ${t.action}`);let o=document.querySelectorAll(\".radio-group.btn-group label\");console.log(`Found ${o.length} action labels`),o.forEach(s=>{s.textContent.trim()===t.action&&(console.log(`Clicking ${t.action} label`),s.click())})}t.qty&&(console.log(`Setting quantity to: ${t.qty}`),await i(\".select-input.combobox input\",t.qty))}function a(o=document){let s=o.querySelectorAll(\".order-history-content .public_fixedDataTable_bodyRow\");return Array.from(s,g=>{let r=g.querySelectorAll(\".public_fixedDataTableCell_cellContent\"),v=r[0]?.textContent.trim()||\"\",x=r[1]?.textContent.trim()||\"\",p=r[2]?.textContent.trim()||\"\",S=r[3]?.textContent.trim()||\"\",I=null,h=p.match(/@([\\d.]+)/);return h&&(I=Number(h[1])),{timestamp:v,id:x,event:p,comment:S,fillPrice:I}})}function m(o=\"up\"){let s=document.querySelector(\".numeric-input-value-controls\");if(!s)return;s.querySelector(o===\"up\"?\".numeric-input-increment\":\".numeric-input-decrement\")?.dispatchEvent(new MouseEvent(\"click\",{bubbles:!0}))}async function f(o,s){await y(),document.querySelector(\".group.order-type .select-input div[tabindex]\")?.click(),[...document.querySelectorAll(\"ul.dropdown-menu li\")].find(r=>r.textContent.trim()===o)?.click(),s&&await i(\".numeric-input.feedback-wrapper input\",s),m(),document.querySelector(\".btn-group .btn-primary\")?.click(),await k(200),console.log(a()),document.querySelector(\".icon.icon-back\")?.click(),await k(200)}return console.log(`Submitting initial ${t.orderType||\"MARKET\"} order`),await f(t.orderType||\"MARKET\",t.entryPrice),t.action===\"Buy\"?(console.log(\"Flipping action to Sell for TP/SL orders\"),t.action=\"Sell\",n&&(console.log(`Creating take profit order at ${t.takeProfit}`),await f(\"LIMIT\",t.takeProfit)),l&&(console.log(`Creating stop loss order at ${t.stopLoss}`),await f(\"STOP\",t.stopLoss))):(console.log(\"Flipping action to Buy for TP/SL orders\"),t.action=\"Buy\",n&&(console.log(`Creating take profit order at ${t.takeProfit}`),await f(\"LIMIT\",t.takeProfit)),l&&(console.log(`Creating stop loss order at ${t.stopLoss}`),await f(\"STOP\",t.stopLoss))),console.log(\"Bracket order creation complete\"),Promise.resolve()}function he(t=document){let n=t.querySelectorAll(\".order-history-content .public_fixedDataTable_bodyRow\");return Array.from(n,l=>{let i=l.querySelectorAll(\".public_fixedDataTableCell_cellContent\"),y=i[0]?.textContent.trim()||\"\",a=i[1]?.textContent.trim()||\"\",m=i[2]?.textContent.trim()||\"\",f=i[3]?.textContent.trim()||\"\",o=null,s=m.match(/@([\\d.]+)/);return s&&(o=Number(s[1])),{timestamp:y,id:a,event:m,comment:f,fillPrice:o}})}let Y={MNQ:{tickSize:.25,tickValue:.5,defaultSL:40,defaultTP:100,precision:2},NQ:{tickSize:.25,tickValue:5,defaultSL:40,defaultTP:100,precision:2},ES:{tickSize:.25,tickValue:12.5,defaultSL:40,defaultTP:100,precision:2},RTY:{tickSize:.1,tickValue:5,defaultSL:90,defaultTP:225,precision:1},YM:{tickSize:1,tickValue:5,defaultSL:10,defaultTP:25,precision:0},CL:{tickSize:.01,tickValue:10,defaultSL:50,defaultTP:100,precision:2},GC:{tickSize:.1,tickValue:10,defaultSL:15,defaultTP:30,precision:1},MGC:{tickSize:.1,tickValue:1,defaultSL:15,defaultTP:30,precision:1}};function N(t,n=1,l=\"Buy\",i=null,y=null,a=.25){console.log(`autoTrade called with: symbol=${t}, qty=${n}, action=${l}, TP=${i}, SL=${y}, tickSize=${a}`);let m=document.getElementById(\"symbolInput\").value||\"NQ\";console.log(`Using symbol: ${m}`);let f=m.replace(/[A-Z]\\d+$/,\"\");console.log(`Root symbol: ${f}`);let o=Y[f];f!==N.lastRootSymbol&&(document.getElementById(\"tickInput\").value=o?.tickSize??\"\"),N.lastRootSymbol=f;let s=o&&typeof o.tickSize==\"number\"?o.tickSize:parseFloat(document.getElementById(\"tickInput\").value)||a;tickInput.value=s,localStorage.setItem(\"bracketTrade_tick\",s);let g=y||o?.defaultSL||parseInt(document.getElementById(\"slInput\").value)||40,r=i||o?.defaultTP||parseInt(document.getElementById(\"tpInput\").value)||100,v=o?.tickSize?\"dictionary\":document.getElementById(\"tickInput\").value?\"input field\":\"default parameter\";console.log(`Using tick size ${s} (from ${v})`),console.log(`Using SL: ${g} ticks, TP: ${r} ticks`),console.log(`Getting market data for ${m}`);let x=le(m);if(!x){console.error(`No market data for ${m}`);return}console.log(\"Market data:\",x);let p=document.getElementById(\"entryPriceInput\"),S=p&&p.value?parseFloat(p.value):null,I=parseFloat(l===\"Buy\"?x.offerPrice:x.bidPrice);console.log(`Market price: ${I} (${l===\"Buy\"?\"offer\":\"bid\"} price)`);let h=\"MARKET\",T=I;S!==null?(console.log(`Custom entry price provided: ${S}`),T=S,l===\"Buy\"?h=S<I?\"LIMIT\":\"STOP\":h=S>I?\"LIMIT\":\"STOP\",console.log(`Order type determined to be: ${h}`)):console.log(`No custom entry price provided, using market order at ${I}`);let E=o?.precision??2;console.log(`Using price precision: ${E} decimal places`);let B=document.getElementById(\"slPriceInput\"),P=document.getElementById(\"tpPriceInput\"),e=B&&B.value?parseFloat(B.value):null,d=P&&P.value?parseFloat(P.value):null,c;e!==null?(c=e.toFixed(E),console.log(`Using hardcoded SL price: ${c}`)):(c=(l===\"Buy\"?T-g*s:T+g*s).toFixed(E),console.log(`Calculated SL price: ${c} (${l===\"Buy\"?\"entry - \":\"entry + \"}${g} ticks)`));let u;d!==null?(u=d.toFixed(E),console.log(`Using hardcoded TP price: ${u}`)):(u=(l===\"Buy\"?T+r*s:T-r*s).toFixed(E),console.log(`Calculated TP price: ${u} (${l===\"Buy\"?\"entry + \":\"entry - \"}${r} ticks)`));let b={symbol:x.symbol,action:l,qty:n.toString(),takeProfit:u,stopLoss:c,orderType:h,entryPrice:h!==\"MARKET\"?T.toFixed(E):null};return console.log(\"Trade data prepared:\",b),console.log(\"Submitting bracket orders\"),oe(b).finally(()=>{let w=Y[f],$=document.getElementById(\"slInput\"),F=document.getElementById(\"tpInput\")})}function ne(t){console.log(`getFrontQuarter called for root: \"${t}\"`);let{letter:n,yearDigit:l}=G();console.log(`Got quarterly code: letter=${n}, yearDigit=${l}`);let i=`${t.toUpperCase()}${n}${l}`;return console.log(`Returning front quarter symbol: \"${i}\"`),i}function le(t){console.log(`getMarketData called for: \"${t}\"`);let n=/^[A-Z]{1,3}$/.test(t)?O(t):t.toUpperCase(),l=re(n);if(!l)return console.log(`Cannot Find ${t}`),null;let i=l.querySelectorAll(\".public_fixedDataTableCell_cellContent\"),y=i[4]?.textContent.trim(),a=i[5]?.textContent.trim();return{symbol:n,bidPrice:y,offerPrice:a}}function re(t){let n=/^[A-Z]{1,3}$/.test((t||\"\").trim()),l=n?null:m(t),i=n?m(t):null,y=document.querySelectorAll(\".quoteboard.module.data-table, .data-table, .quoteboard\"),a=y.length?y:[document];for(let f of a){let o=f.querySelectorAll(\".public_fixedDataTable_bodyRow\");for(let s of o){if(s.offsetParent===null)continue;let g=s.querySelector(\".public_fixedDataTableCell_cellContent\");if(!g)continue;let r=m(g.textContent);if(l&&r===l||i&&r.startsWith(i))return s}}return console.error(`findQuoteRow: row for \"${t}\" not found (visible area).`),null;function m(f){return String(f||\"\").replace(/[\\u2000-\\u200F\\u2028\\u2029\\u202F\\u00A0]/g,\" \").replace(/\\s+/g,\" \").trim().toUpperCase()}}let ce=[\"F\",\"G\",\"H\",\"J\",\"K\",\"M\",\"N\",\"Q\",\"U\",\"V\",\"X\",\"Z\"];function we(t=new Date){console.log(`getMonthlyCode called with date: ${t.toISOString()}`);let n=ce[t.getUTCMonth()],l=t.getUTCFullYear()%10+\"\";return console.log(`Calculated monthly code: letter=${n}, yearDigit=${l}`),{letter:n,yearDigit:l}}function _(t=new Date){console.log(`getNQFrontMonth called with date: ${t.toISOString()}`);let n=[3,6,9,12],l=[\"H\",\"M\",\"U\",\"Z\"],i=t.getFullYear(),y=t.getMonth()+1,a=t.getDate();console.log(`Current date: ${i}-${y}-${a}`);for(let o=0;o<n.length;o++){let s=n[o],g=D(i,s),r=new Date(g);if(r.setDate(g.getDate()-4),console.log(`Checking ${l[o]} contract: expiry=${g.toISOString()}, roll=${r.toISOString()}`),t<r){let v=`NQ${l[o]}${String(i).slice(-2)}`;return console.log(`Current front month: ${v} (before roll date)`),{symbol:v,letter:l[o],yearDigit:String(i).slice(-2),expiry:g,rollDate:r,isRollPeriod:!1}}else if(t<g){let v=(o+1)%4,x=v>o?i:i+1,p=`NQ${l[v]}${String(x).slice(-2)}`;return console.log(`Front month during roll period: ${p}`),{symbol:p,letter:l[v],yearDigit:String(x).slice(-2),expiry:D(x,n[v]),rollDate:r,isRollPeriod:!0}}}let m=i+1,f=`NQ${l[0]}${String(m).slice(-2)}`;return console.log(`Moving to next year: ${f}`),{symbol:f,letter:l[0],yearDigit:String(m).slice(-2),expiry:D(m,n[0]),rollDate:null,isRollPeriod:!1}}function D(t,n){let i=(5-new Date(t,n-1,1).getDay()+7)%7,y=new Date(t,n-1,1+i),a=new Date(y);return a.setDate(y.getDate()+14),a}function G(t=new Date){console.log(`getQuarterlyCode called (legacy) with date: ${t.toISOString()}`);let n=_(t);return console.log(`Legacy getQuarterlyCode returning: letter=${n.letter}, yearDigit=${n.yearDigit}`),{letter:n.letter,yearDigit:String(n.yearDigit).slice(-1)}}console.log(\"Calculating current NQ front month using CME rules...\");let Q=_();console.log(`Current NQ front month: ${Q.symbol}`),console.log(`Expiry date: ${Q.expiry.toISOString()}`),console.log(`Roll date: ${Q.rollDate?Q.rollDate.toISOString():\"N/A\"}`),console.log(`Is in roll period: ${Q.isRollPeriod}`);let{letter:ie,yearDigit:ae}=G(),se=`NQ${ie}${ae}`;console.log(`Legacy front-quarter symbol: ${se}`),window.getNQFrontMonth=_,window.getThirdFriday=D;let U={init:()=>{console.log(\"[TradoAuto] legacy driver init\")},autoTrade:N,clickExitForSymbol:q,moveStopLossToBreakeven,createUI:A,getNQFrontMonth:_,getThirdFriday:D},R=typeof unsafeWindow<\"u\"?unsafeWindow:window;window.TradoAuto=U,R.TradoAuto=U,R.TradovateAutoDriverBundle={default:U,autoTrade:N,clickExitForSymbol:q,moveStopLossToBreakeven,createUI:A,getNQFrontMonth:_,getThirdFriday:D},R.__tradoAutoInterval||(R.__tradoAutoInterval=setInterval(()=>{(!R.TradoAuto||typeof R.TradoAuto.autoTrade!=\"function\")&&(R.TradoAuto=U),(!window.TradoAuto||typeof window.TradoAuto.autoTrade!=\"function\")&&(window.TradoAuto=U)},250))})();function ve(){return typeof window<\"u\"&&window.TradoAuto?window.TradoAuto:TradoAuto}var Se=typeof window<\"u\"&&window.TradoAuto?window.TradoAuto:TradoAuto;return ke(Ie);})();\n//# sourceMappingURL=tradovate_auto_driver.js.map\n";
    const panelSource = "var TradovateUIPanelBundle=(()=>{var ae=Object.defineProperty;var Ie=Object.getOwnPropertyDescriptor;var Se=Object.getOwnPropertyNames;var Ee=Object.prototype.hasOwnProperty;var he=(h,k)=>{for(var I in k)ae(h,I,{get:k[I],enumerable:!0})},we=(h,k,I,N)=>{if(k&&typeof k==\"object\"||typeof k==\"function\")for(let L of Se(k))!Ee.call(h,L)&&L!==I&&ae(h,L,{get:()=>k[L],enumerable:!(N=Ie(k,L))||N.enumerable});return h};var $e=h=>we(ae({},\"__esModule\",{value:!0}),h);var Te={};he(Te,{createUIPanel:()=>be,default:()=>Be});(function(){\"use strict\";console.log(\"Auto Order script initialized\");var h=!1;function k(e){return console.log(`Delaying for ${e}ms`),new Promise(n=>setTimeout(n,e))}function I(){console.log(\"Creating UI\");let e=localStorage.getItem(\"bracketTrade_tp\")||\"120\",n=localStorage.getItem(\"bracketTrade_sl\")||\"40\",l=localStorage.getItem(\"bracketTrade_qty\")||\"9\",c=localStorage.getItem(\"bracketTrade_tick\")||\"0.25\",b=localStorage.getItem(\"bracketTrade_symbol\")||\"NQ\";console.log(`Stored values: TP=${e}, SL=${n}, Qty=${l}, Tick=${c}, Symbol=${b}`);let a=document.createElement(\"div\");a.id=\"bracket-trade-box\",Object.assign(a.style,{position:\"fixed\",background:\"#1e1e1e\",border:\"1px solid #444\",padding:\"12px\",zIndex:\"99999\",boxShadow:\"0 2px 10px rgba(0,0,0,0.5)\",borderRadius:\"8px\",color:\"#fff\",cursor:\"move\",fontFamily:\"sans-serif\",textAlign:\"center\",width:\"200px\"});let f=0,v=0;f&&v?(a.style.left=f,a.style.top=v):(a.style.top=\"20px\",a.style.right=\"20px\"),a.innerHTML=`\n    <!-- Header with Symbol -->\n    <div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;\">\n        <span style=\"font-weight:bold;cursor:grab;\">\\u283F Bracket</span>\n        <input type=\"text\" id=\"symbolInput\" value=\"${b}\"\n            style=\"width:50%;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\"\n            placeholder=\"Symbol\" />\n    </div>\n\n    <!-- Hidden Tick Size Input -->\n    <div id=\"tickContainer\" style=\"display:none;margin-bottom:8px;\">\n        <label style=\"display:block;margin-bottom:4px;font-size:11px;\">Tick Size</label>\n        <input type=\"number\" id=\"tickInput\" step=\"0.01\" value=\"${c}\"\n            style=\"width:100%;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\" />\n    </div>\n\n    <!-- Main Controls -->\n    <div id=\"mainControls\">\n        <div style=\"display:flex;align-items:center;gap:8px;margin-bottom:8px;\">\n            <input type=\"checkbox\" id=\"tpCheckbox\" checked />\n            <div style=\"display:flex;gap:4px;flex:1;\">\n                <input type=\"number\" id=\"tpInput\" value=\"${e}\" step=\"1\"\n                    style=\"width:50%;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\"\n                    placeholder=\"TP Ticks\" />\n                <input type=\"number\" id=\"tpPriceInput\" step=\"0.01\"\n                    style=\"width:50%;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\"\n                    placeholder=\"TP Price\" />\n            </div>\n        </div>\n        <div style=\"display:flex;align-items:center;gap:8px;margin-bottom:12px;\">\n            <input type=\"checkbox\" id=\"slCheckbox\" checked />\n            <div style=\"display:flex;gap:4px;flex:1;\">\n                <input type=\"number\" id=\"slInput\" value=\"${n}\" step=\"1\"\n                    style=\"width:50%;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\"\n                    placeholder=\"SL Ticks\" />\n                <input type=\"number\" id=\"slPriceInput\" step=\"0.01\"\n                    style=\"width:50%;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\"\n                    placeholder=\"SL Price\" />\n            </div>\n        </div>\n        <div style=\"display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:12px;\">\n            <button id=\"buyBtn\"  style=\"padding:6px 10px;background:#2ecc71;color:#fff;border:none;border-radius:4px;font-weight:bold;\">Buy</button>\n            <div style=\"display:flex;flex-direction:column;gap:4px;\">\n                <input type=\"number\" id=\"entryPriceInput\" placeholder=\"Entry\" step=\"1\"\n                    style=\"width:80px;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\" />\n                <input type=\"number\" id=\"qtyInput\" value=\"${l}\" min=\"1\"\n                    style=\"width:80px;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\" />\n            </div>\n            <button id=\"sellBtn\" style=\"padding:6px 10px;background:#e74c3c;color:#fff;border:none;border-radius:4px;font-weight:bold;\">Sell</button>\n        </div>\n        <div style=\"display:flex;gap:10px;margin-bottom:2px;\">\n            <button id=\"cancelAllBtn\" style=\"flex:1;padding:12px 8px;background:#e6b800;color:#000;border:none;border-radius:4px;font-weight:bold;\">Cancel</button>\n            <button id=\"closeAllBtn\" style=\"flex:3;padding:12px 8px;background:#e74c3c;color:#fff;border:none;border-radius:4px;font-weight:bold;\">Close All</button>\n        </div>\n\n        <!-- NEW: Breakeven button above Reverse -->\n        <div style=\"display:flex;gap:10px;margin-top:6px;\">\n            <button id=\"breakevenBtn\" style=\"flex:1;padding:12px 8px;background:#6c5ce7;color:#fff;border:none;border-radius:4px;font-weight:bold;\">Breakeven</button>\n        </div>\n\n        <div style=\"display:flex;gap:10px;margin-top:6px;\">\n            <button id=\"reverseBtn\" style=\"flex:1;padding:12px 8px;background:#ff6600;color:#fff;border:none;border-radius:4px;font-weight:bold;\">Reverse</button>\n        </div>\n    </div>`,document.body.appendChild(a),console.log(\"UI container added to DOM\");let o=document.createElement(\"div\");o.id=\"bracket-trade-tray\",Object.assign(o.style,{position:\"fixed\",top:a.style.top||\"20px\",left:\"0px\",background:\"#24262b\",border:\"1px solid #444\",padding:\"10px\",borderRadius:\"8px\",boxShadow:\"0 2px 10px rgba(0,0,0,0.4)\",color:\"#fff\",width:\"140px\",zIndex:\"99999\",display:\"none\"}),o.innerHTML=`\n      <div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;\">\n        <div style=\"font-weight:600;\">Price Tray</div>\n        <button id=\"trayCloseBtn\" title=\"Hide\"\n          style=\"background:#333;border:1px solid #555;color:#fff;border-radius:4px;padding:2px 6px;cursor:pointer;\">\\xD7</button>\n      </div>\n      <div style=\"display:flex;flex-direction:column;gap:6px\">\n        <button id=\"tray-btn-high\"  style=\"padding:6px;border:1px solid #555;background:#2a2d34;color:#fff;border-radius:6px;text-align:left;\">High</button>\n        <button id=\"tray-btn-low\"   style=\"padding:6px;border:1px solid #555;background:#2a2d34;color:#fff;border-radius:6px;text-align:left;\">Low</button>\n        <button id=\"tray-btn-open\"  style=\"padding:6px;border:1px solid #555;background:#2a2d34;color:#fff;border-radius:6px;text-align:left;\">Open</button>\n        <button id=\"tray-btn-close\" style=\"padding:6px;border:1px solid #555;background:#2a2d34;color:#fff;border-radius:6px;text-align:left;\">Close</button>\n        <button id=\"tray-btn-mid\"   style=\"padding:6px;border:1px solid #555;background:#2a2d34;color:#fff;border-radius:6px;text-align:left;\">Middle</button>\n      </div>\n    `,document.body.appendChild(o);let s=document.createElement(\"button\");s.id=\"trayToggle\",s.textContent=\"\\u25C2 O/L/H/C/M\",Object.assign(s.style,{position:\"absolute\",right:\"-92px\",top:\"0\",height:\"32px\",background:\"#30343b\",color:\"#fff\",border:\"1px solid #444\",borderRadius:\"0 8px 8px 0\",padding:\"4px 8px\",cursor:\"pointer\"}),a.appendChild(s);function m(){let t=a.getBoundingClientRect();o.style.top=`${t.top}px`,o.style.left=`${t.right+8}px`}m(),window.addEventListener(\"resize\",m),s.addEventListener(\"click\",()=>{m(),o.style.display=o.style.display===\"none\"?\"block\":\"none\"}),o.querySelector(\"#trayCloseBtn\")?.addEventListener(\"click\",()=>{o.style.display=\"none\"});let r=null;function B(){let t=(document.getElementById(\"tickInput\")?.value||\"\").toString(),d=t.indexOf(\".\");return d===-1?0:t.length-d-1}setInterval(()=>{try{if(typeof L==\"function\"){if(r=L(),r){let t={open:[\"tray-btn-open\",\"Open\"],low:[\"tray-btn-low\",\"Low\"],high:[\"tray-btn-high\",\"High\"],close:[\"tray-btn-close\",\"Close\"]};for(let[i,[p,x]]of Object.entries(t)){let D=document.getElementById(p);if(!D)continue;let O=r[i];D.title=O!=null?`${x}: ${O}`:`${x}: \\u2014`}let d=document.getElementById(\"tray-btn-mid\");if(d){let i=r.open,p=r.close;if(typeof i==\"number\"&&typeof p==\"number\"){let x=B(),D=((i+p)/2).toFixed(x);d.title=`Mid (O+C)/2: ${D}`}else d.title=\"Mid (O+C)/2: \\u2014\"}}m()}}catch(t){console.warn(\"extractTradovateDataBox polling error:\",t)}},500);function w(t){let d=document.getElementById(\"entryPriceInput\");if(!d||t==null)return;Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,\"value\").set.call(d,t),[\"input\",\"change\",\"blur\"].forEach(p=>d.dispatchEvent(new Event(p,{bubbles:!0})))}function y(t){if(!r||r[t]==null){console.warn(`No ${t} available from databox`);return}w(r[t])}function T(){if(!r||typeof r.open!=\"number\"||typeof r.close!=\"number\"){console.warn(\"Mid price unavailable (need open & close)\");return}let t=B(),d=((r.high+r.low)/2).toFixed(t);w(d)}document.getElementById(\"tray-btn-open\")?.addEventListener(\"click\",()=>y(\"open\")),document.getElementById(\"tray-btn-low\")?.addEventListener(\"click\",()=>y(\"low\")),document.getElementById(\"tray-btn-high\")?.addEventListener(\"click\",()=>y(\"high\")),document.getElementById(\"tray-btn-close\")?.addEventListener(\"click\",()=>y(\"close\")),document.getElementById(\"tray-btn-mid\")?.addEventListener(\"click\",T),console.log(\"Setting up UI event handlers\");let C=document.getElementById(\"slInput\"),A=document.getElementById(\"tpInput\"),_=document.getElementById(\"qtyInput\");document.getElementById(\"slInput\").addEventListener(\"input\",()=>{console.log(`SL input changed to: ${C.value}`);let t=parseFloat(C.value);isNaN(t)||(A.value=t*3,console.log(`Calculated TP: ${A.value} (SL \\xD7 3)`)),localStorage.setItem(\"bracketTrade_sl\",C.value),localStorage.setItem(\"bracketTrade_tp\",A.value)}),A.addEventListener(\"input\",()=>{console.log(`TP input changed to: ${A.value}`),localStorage.setItem(\"bracketTrade_tp\",A.value)}),document.getElementById(\"qtyInput\").addEventListener(\"input\",t=>{console.log(`Quantity input changed to: ${t.target.value}`),localStorage.setItem(\"bracketTrade_qty\",t.target.value)}),document.getElementById(\"closeAllBtn\").addEventListener(\"click\",()=>{console.log(\"Close All button clicked\");try{let t=document.getElementById(\"symbolInput\").value||\"NQ\",d=q(t);console.log(`Calling clickExitForSymbol for: ${d} with Exit at Mkt & Cxl option`),N(d,\"cancel-option-Exit-at-Mkt-Cxl\"),console.log(\"Exit action triggered for symbol:\",d)}catch(t){console.error(\"Close All operation failed:\",t);try{console.log(\"Attempting fallback close method with danger buttons\"),document.getElementsByClassName(\"btn btn-danger\")[0]?.click(),setTimeout(()=>{document.getElementsByClassName(\"btn btn-danger\")[1]?.click(),document.getElementsByClassName(\"btn btn-danger\")[2]?.click()},200)}catch(d){console.error(\"Fallback close method also failed:\",d)}}}),document.getElementById(\"cancelAllBtn\").addEventListener(\"click\",()=>{console.log(\"Cancel All button clicked\");try{let t=document.getElementById(\"symbolInput\").value||\"NQ\",d=q(t);console.log(`Calling clickExitForSymbol for: ${d} with Cancel All option`),N(d,\"cancel-option-Cancel-All\"),console.log(\"Cancel All action triggered for symbol:\",d)}catch(t){console.error(\"Cancel All operation failed:\",t)}}),document.getElementById(\"reverseBtn\").addEventListener(\"click\",()=>{console.log(\"Reverse Position button clicked\");try{let t=document.getElementById(\"symbolInput\").value||\"NQ\",d=q(t);console.log(`Calling clickExitForSymbol for: ${d} with Reverse & Cxl option`),N(d,\"cancel-option-Reverse-Cxl\"),console.log(\"Reverse Position action triggered for symbol:\",d)}catch(t){console.error(\"Reverse Position operation failed:\",t)}}),document.getElementById(\"breakevenBtn\").addEventListener(\"click\",async()=>{console.log(\"Breakeven button clicked\");try{let t=document.getElementById(\"symbolInput\").value||\"NQ\",d=q(t);console.log(`Breakeven for symbol: ${d}`);let i=Q=>(Q||\"\").replace(/\\s+/g,\" \").trim().toUpperCase(),p=[...document.querySelectorAll(\".contract-symbol span\")].find(Q=>{let ee=i(Q.textContent),ke=i(d);return ee===ke||ee.startsWith(i(t))});if(!p)return console.error(\"Breakeven: contract header not found\");let D=[...(p.closest(\".gm-scroll-view\")||p.closest(\".header\")||document).querySelectorAll(\".info-column\")].find(Q=>/position/i.test(Q.querySelector(\"small\")?.textContent||\"\"));if(!D){console.error(\"Breakeven: Position column not found\");return}let O=D.querySelector(\".number\"),G=O?.querySelector(\"span\"),ue=(O?.textContent||\"\").trim().match(/@([\\d.,]+)/);if(!ue){console.error(\"Breakeven: could not parse entry price from Position\");return}let pe=parseFloat(ue[1].replace(/,/g,\"\")),le=1;if(G){let Q=parseFloat(G.textContent.replace(/[^\\d.-]/g,\"\"));!isNaN(Q)&&Q!==0&&(le=Math.abs(Q))}let re=\"LONG\",ge=G?.classList||O?.classList||{contains:()=>!1};ge.contains(\"text-danger\")&&(re=\"SHORT\"),ge.contains(\"text-success\")&&(re=\"LONG\");let ye=re===\"LONG\"?\"Sell\":\"Buy\";console.log(`Breakeven detected: side=${re}, qty=${le}, entry=${pe}. Placing ${ye} LIMIT at entry.`);let ie=document.getElementById(\"tpCheckbox\"),ce=document.getElementById(\"slCheckbox\"),fe=ie.checked,xe=ce.checked;ie.checked=!1,ce.checked=!1;let ve=(()=>{let ee=(parseFloat(document.getElementById(\"tickInput\").value)||.25).toString();return ee.includes(\".\")?ee.length-ee.indexOf(\".\")-1:0})();document.getElementById(\"entryPriceInput\").value=pe.toFixed(ve),document.getElementById(\"qtyInput\").value=le.toString(),[\"input\",\"change\",\"blur\"].forEach(Q=>{document.getElementById(\"entryPriceInput\").dispatchEvent(new Event(Q,{bubbles:!0})),document.getElementById(\"qtyInput\").dispatchEvent(new Event(Q,{bubbles:!0}))}),await F(t,le,ye,null,null,parseFloat(document.getElementById(\"tickInput\").value)||.25),ie.checked=fe,ce.checked=xe,document.getElementById(\"entryPriceInput\").value=\"\",[\"input\",\"change\",\"blur\"].forEach(Q=>document.getElementById(\"entryPriceInput\").dispatchEvent(new Event(Q,{bubbles:!0})))}catch(t){console.error(\"Breakeven action failed:\",t)}}),console.log(\"Setting up persistent settings\"),document.getElementById(\"symbolInput\").value=localStorage.getItem(\"bracketTrade_symbol\")||\"NQ\",document.getElementById(\"symbolInput\").addEventListener(\"input\",t=>{console.log(`Symbol input changed to: ${t.target.value}`),localStorage.setItem(\"bracketTrade_symbol\",t.target.value)}),document.getElementById(\"symbolInput\").addEventListener(\"change\",t=>{let d=t.target.value,i=q(d);console.log(`Symbol changed to: ${d}, normalized: ${i}`);let p=d.replace(/[A-Z]\\d+$/,\"\"),x=z[p];if(x){console.log(`Found default values for ${p}: SL=${x.defaultSL}, TP=${x.defaultTP}`);let D=document.getElementById(\"slInput\"),O=document.getElementById(\"tpInput\"),G=document.getElementById(\"tickInput\");D.value=x.defaultSL,O.value=x.defaultTP,typeof x.tickSize==\"number\"&&(G.value=x.tickSize,localStorage.setItem(\"bracketTrade_tick\",x.tickSize),console.log(`Updated tick size to ${x.tickSize} for ${p}`)),localStorage.setItem(\"bracketTrade_sl\",x.defaultSL),localStorage.setItem(\"bracketTrade_tp\",x.defaultTP),console.log(`Updated SL/TP to default values for ${p}: SL=${D.value}, TP=${O.value}`)}U(\".search-box--input\",i)}),document.getElementById(\"tickInput\").value=localStorage.getItem(\"bracketTrade_tick\")||\"0.25\",document.getElementById(\"tickInput\").addEventListener(\"input\",t=>{console.log(`Tick size input changed to: ${t.target.value}`),localStorage.setItem(\"bracketTrade_tick\",t.target.value)}),console.log(\"Setting up drag functionality\");let P=!1,V,X;a.addEventListener(\"mousedown\",t=>{console.log(\"Container mousedown event detected\"),P=!0,V=t.clientX-a.getBoundingClientRect().left,X=t.clientY-a.getBoundingClientRect().top,console.log(`Drag started at offset X:${V}, Y:${X}`),a.style.cursor=\"grabbing\"}),document.addEventListener(\"mousemove\",t=>{if(P){let d=`${t.clientX-V}px`,i=`${t.clientY-X}px`;t.clientX%20===0&&console.log(`Dragging panel to X:${d}, Y:${i}`),a.style.left=d,a.style.top=i,a.style.right=\"unset\",m()}}),document.addEventListener(\"mouseup\",()=>{P&&(console.log(`Container drop position: Left:${a.style.left}, Top:${a.style.top}`),localStorage.setItem(\"bracketTradeBoxLeft\",a.style.left),localStorage.setItem(\"bracketTradeBoxTop\",a.style.top)),P=!1,a.style.cursor=\"grab\"}),console.log(\"Setting up trade buttons\"),document.getElementById(\"buyBtn\").addEventListener(\"click\",()=>{console.log(\"BUY button clicked\");let t=document.getElementById(\"symbolInput\").value||\"NQ\",d=+_.value,i=+A.value,p=+C.value,x=+document.getElementById(\"tickInput\").value;console.log(`Initiating BUY order: Symbol=${t}, Qty=${d}, TP=${i}, SL=${p}, TickSize=${x}`),F(t,d,\"Buy\",i,p,x).finally(()=>{document.getElementById(\"entryPriceInput\").value=\"\",document.getElementById(\"tpPriceInput\").value=\"\",document.getElementById(\"slPriceInput\").value=\"\",console.log(\"Price inputs reset after BUY order\")})}),document.getElementById(\"sellBtn\").addEventListener(\"click\",()=>{console.log(\"SELL button clicked\");let t=document.getElementById(\"symbolInput\").value||\"NQ\",d=+_.value,i=+A.value,p=+C.value,x=+document.getElementById(\"tickInput\").value;console.log(`Initiating SELL order: Symbol=${t}, Qty=${d}, TP=${i}, SL=${p}, TickSize=${x}`),F(t,d,\"Sell\",i,p,x).finally(()=>{document.getElementById(\"entryPriceInput\").value=\"\",document.getElementById(\"tpPriceInput\").value=\"\",document.getElementById(\"slPriceInput\").value=\"\",console.log(\"Price inputs reset after SELL order\")})})}async function N(e,n=\"cancel-option-Exit-at-Mkt-Cxl\"){let l={exit:\"cancel-option-Exit-at-Mkt-Cxl\",reverse:\"cancel-option-Reverse-Cxl\",\"cancel-all\":\"cancel-option-Cancel-All\",\"cancel-bids\":\"cancel-option-Cancel-Bids\",\"cancel-offers\":\"cancel-option-Cancel-Offers\"},c={\"cancel-option-Exit-at-Mkt-Cxl\":/EXIT\\s*AT\\s*MKT/i,\"cancel-option-Reverse-Cxl\":/REVERSE\\s*&\\s*CXL/i,\"cancel-option-Cancel-All\":/CANCEL\\s*ALL/i,\"cancel-option-Cancel-Bids\":/CANCEL\\s*BIDS/i,\"cancel-option-Cancel-Offers\":/CANCEL\\s*OFFERS/i},b=i=>(i||\"\").replace(/[\\u2000-\\u200F\\u2028\\u2029\\u202F\\u00A0]/g,\" \").replace(/\\s+/g,\" \").trim().toUpperCase(),a=i=>new Promise(p=>setTimeout(p,i));async function f(i,{timeout:p=1200,interval:x=50}={}){let D=performance.now();for(;performance.now()-D<p;){let O=i();if(O)return O;await a(x)}return null}let v=n.toLowerCase(),o=l[v]||n,s=c[o]||null,m=b(e),r=/^[A-Z]{1,3}$/.test(m),B=[...document.querySelectorAll(\".header .contract-symbol span\")].find(i=>{let p=b(i.textContent);return p===m||r&&p.startsWith(m)});if(!B)return console.error(\"clickExitForSymbol: contract header not found\"),!1;let y=B.closest(\".header\")?.querySelector(\".dropdown.btn-group.btn-split.btn-group-default\"),T=y?.querySelector(\".btn.btn-default:not(.dropdown-toggle)\"),C=y?.querySelector(\".dropdown-toggle.btn.btn-default\");if(!y||!T||!C)return console.error(\"clickExitForSymbol: split button not found\"),!1;if(s?s.test(b(T.textContent)):!1)return T.click(),!0;C.dispatchEvent(new MouseEvent(\"click\",{bubbles:!0}));let _=()=>[...document.querySelectorAll(\".dropdown-menu\")].filter(i=>i.offsetParent!==null||/display\\s*:\\s*block/i.test(i.getAttribute(\"style\")||\"\")||!!i.closest(\".open\")),P=await f(_,{timeout:900,interval:40});if(!P||!P.length)return console.error(\"clickExitForSymbol: dropdown menu not visible\"),!1;let V=C.getBoundingClientRect();P.sort((i,p)=>{let x=i.getBoundingClientRect(),D=p.getBoundingClientRect(),O=Math.hypot(x.left-V.left,x.top-V.bottom),G=Math.hypot(D.left-V.left,D.top-V.bottom);return O-G});let X=P[0],t=document.getElementById(o);if(!t&&s){for(let i of P)if(t=[...i.querySelectorAll('a[role=\"menuitem\"], a, button, li, span')].find(p=>s.test(b(p.textContent))),t){X=i;break}}if(!t)return console.error(\"clickExitForSymbol: desired menu item not found\"),!1;let d=t.tagName?t.matches(\"a,button\")?t:t.querySelector(\"a,button\")||t:t;return[\"mousedown\",\"mouseup\",\"click\"].forEach(i=>d.dispatchEvent(new MouseEvent(i,{bubbles:!0}))),C.click(),await a(120),P=_(),t=document.getElementById(o)||(s?P?.flatMap(i=>[...i.querySelectorAll('a[role=\"menuitem\"], a, button, li, span')]).find(i=>s.test(b(i.textContent))):null),t?([\"mousedown\",\"mouseup\",\"click\"].forEach(i=>(t.querySelector(\"a,button\")||t).dispatchEvent(new MouseEvent(i,{bubbles:!0}))),await a(80),T.click(),!0):(console.error(\"clickExitForSymbol: primary did not update; giving up\"),!1)}function L(e=document){let n=[...e.querySelectorAll(\".databox.react-draggable.react-resizable\")].find(f=>f.offsetParent!==null);if(!n)return null;let b={timestamp:((f,v=n)=>{let o=v.querySelector(f);return o?o.textContent.trim():null})(\".header .title\")||null};return n.querySelectorAll(\".gm-scroll-view .entries li\").forEach(f=>{let v=f.querySelector(\".label\"),o=f.querySelector(\".desc\");if(!v||!o)return;let s=v.cloneNode(!0);s.querySelectorAll(\"span\").forEach(T=>T.remove());let m=(s.textContent||\"\").trim().toLowerCase().replace(/[^a-z0-9]/g,\"\"),r=(o.textContent||\"\").trim(),w={open:\"open\",high:\"high\",low:\"low\",close:\"close\",volume:\"volume\",atr:\"atr\",vwap:\"vwap\",upperband1:\"upperBand1\",lowerband1:\"lowerBand1\",upperband2:\"upperBand2\",lowerband2:\"lowerBand2\"}[m]||m,y=r.replace(/,/g,\"\");w===\"volume\"?y=Number.parseInt(y,10):y=Number.parseFloat(y),b[w]=Number.isNaN(y)?r:y}),b}document.querySelectorAll(\"#bracket-trade-box, #bracket-trade-tray\").forEach(e=>e.remove()),I(),console.log(\"UI creation complete\");async function U(e,n){console.log(`updateSymbol called with selector: \"${e}\", value: \"${n}\"`);let l=document.querySelectorAll(e);console.log(`Found ${l.length} matching inputs`);let c=l[1]||l[0];if(!c){console.error(\"No matching input elements found!\");return}console.log(\"Selected input:\",c);let b=Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,\"value\").set,a=f=>c.dispatchEvent(new KeyboardEvent(f,{key:\"Enter\",code:\"Enter\",keyCode:13,which:13,bubbles:!0,cancelable:!0}));console.log(\"Clearing input field\"),b.call(c,\"\"),c.focus(),c.dispatchEvent(new Event(\"input\",{bubbles:!0})),await k(400),console.log(`Setting input value to: \"${n}\"`),b.call(c,n),c.focus(),c.dispatchEvent(new Event(\"input\",{bubbles:!0})),await k(900),console.log(\"Simulating Enter key press\"),[\"keydown\",\"keypress\",\"keyup\"].forEach(a),c.dispatchEvent(new Event(\"change\",{bubbles:!0})),console.log(\"Symbol update complete\")}async function te(e){let n=\"input.form-control\";for(let l=0;l<20;l++){let c=document.querySelector(n);if(c&&c.offsetParent){Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,\"value\").set.call(c,e),[\"input\",\"change\",\"blur\"].forEach(a=>c.dispatchEvent(new Event(a,{bubbles:!0}))),await k(300);return}await k(100)}console.error(\"Price input not found\")}function q(e){console.log(`normalizeSymbol called with: \"${e}\"`);let n=/^[A-Z]{1,3}$/.test(e);console.log(`Is root symbol: ${n}`);let l=n?S(e):e.toUpperCase();return console.log(`Normalized symbol: \"${l}\"`),l}async function W(e){console.log(\"Creating bracket orders with data:\",e);let n=document.getElementById(\"tpCheckbox\").checked,l=document.getElementById(\"slCheckbox\").checked;console.log(`TP enabled: ${n}, SL enabled: ${l}`);async function c(o,s){let m=[...document.querySelectorAll(\".trading-ticket\")].find(y=>y.offsetParent);if(!m)return console.error(\"No visible trading ticket\");let r;for(let y=0;y<25&&(r=[...m.querySelectorAll(o)].find(T=>T.offsetParent&&!T.disabled),!r);y++)await k(100);if(!r)return console.error(`No live input for ${o}`);let B=Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,\"value\").set,w=r.closest(\".select-input.combobox\");w&&!r.value&&(w.querySelector(\".btn\")?.click(),await k(150),w.querySelector(\".dropdown-menu li\")?.click(),await k(150));for(let y=0;y<3&&(r.focus(),B.call(r,s),r.dispatchEvent(new Event(\"input\",{bubbles:!0})),r.dispatchEvent(new Event(\"change\",{bubbles:!0})),r.dispatchEvent(new KeyboardEvent(\"keydown\",{key:\"Enter\",code:\"Enter\",keyCode:13,which:13,bubbles:!0})),r.blur(),await k(250),`${r.value}`.trim()!==`${s}`);y++);}async function b(){if(console.log(\"Setting common order fields\"),e.action){console.log(`Setting action to: ${e.action}`);let o=document.querySelectorAll(\".radio-group.btn-group label\");console.log(`Found ${o.length} action labels`),o.forEach(s=>{s.textContent.trim()===e.action&&(console.log(`Clicking ${e.action} label`),s.click())})}e.qty&&(console.log(`Setting quantity to: ${e.qty}`),await c(\".select-input.combobox input\",e.qty))}function a(o=document){let s=o.querySelectorAll(\".order-history-content .public_fixedDataTable_bodyRow\");return Array.from(s,m=>{let r=m.querySelectorAll(\".public_fixedDataTableCell_cellContent\"),B=r[0]?.textContent.trim()||\"\",w=r[1]?.textContent.trim()||\"\",y=r[2]?.textContent.trim()||\"\",T=r[3]?.textContent.trim()||\"\",C=null,A=y.match(/@([\\d.]+)/);return A&&(C=Number(A[1])),{timestamp:B,id:w,event:y,comment:T,fillPrice:C}})}function f(o=\"up\"){let s=document.querySelector(\".numeric-input-value-controls\");if(!s)return;s.querySelector(o===\"up\"?\".numeric-input-increment\":\".numeric-input-decrement\")?.dispatchEvent(new MouseEvent(\"click\",{bubbles:!0}))}async function v(o,s){await b(),document.querySelector(\".group.order-type .select-input div[tabindex]\")?.click(),[...document.querySelectorAll(\"ul.dropdown-menu li\")].find(r=>r.textContent.trim()===o)?.click(),s&&await c(\".numeric-input.feedback-wrapper input\",s),f(),document.querySelector(\".btn-group .btn-primary\")?.click(),await k(200),console.log(a()),document.querySelector(\".icon.icon-back\")?.click(),await k(200)}return console.log(`Submitting initial ${e.orderType||\"MARKET\"} order`),await v(e.orderType||\"MARKET\",e.entryPrice),e.action===\"Buy\"?(console.log(\"Flipping action to Sell for TP/SL orders\"),e.action=\"Sell\",n&&(console.log(`Creating take profit order at ${e.takeProfit}`),await v(\"LIMIT\",e.takeProfit)),l&&(console.log(`Creating stop loss order at ${e.stopLoss}`),await v(\"STOP\",e.stopLoss))):(console.log(\"Flipping action to Buy for TP/SL orders\"),e.action=\"Buy\",n&&(console.log(`Creating take profit order at ${e.takeProfit}`),await v(\"LIMIT\",e.takeProfit)),l&&(console.log(`Creating stop loss order at ${e.stopLoss}`),await v(\"STOP\",e.stopLoss))),console.log(\"Bracket order creation complete\"),Promise.resolve()}function J(e=document){let n=e.querySelectorAll(\".order-history-content .public_fixedDataTable_bodyRow\");return Array.from(n,l=>{let c=l.querySelectorAll(\".public_fixedDataTableCell_cellContent\"),b=c[0]?.textContent.trim()||\"\",a=c[1]?.textContent.trim()||\"\",f=c[2]?.textContent.trim()||\"\",v=c[3]?.textContent.trim()||\"\",o=null,s=f.match(/@([\\d.]+)/);return s&&(o=Number(s[1])),{timestamp:b,id:a,event:f,comment:v,fillPrice:o}})}let z={MNQ:{tickSize:.25,tickValue:.5,defaultSL:40,defaultTP:100,precision:2},NQ:{tickSize:.25,tickValue:5,defaultSL:40,defaultTP:100,precision:2},ES:{tickSize:.25,tickValue:12.5,defaultSL:40,defaultTP:100,precision:2},RTY:{tickSize:.1,tickValue:5,defaultSL:90,defaultTP:225,precision:1},YM:{tickSize:1,tickValue:5,defaultSL:10,defaultTP:25,precision:0},CL:{tickSize:.01,tickValue:10,defaultSL:50,defaultTP:100,precision:2},GC:{tickSize:.1,tickValue:10,defaultSL:15,defaultTP:30,precision:1},MGC:{tickSize:.1,tickValue:1,defaultSL:15,defaultTP:30,precision:1}};function F(e,n=1,l=\"Buy\",c=null,b=null,a=.25){console.log(`autoTrade called with: symbol=${e}, qty=${n}, action=${l}, TP=${c}, SL=${b}, tickSize=${a}`);let f=document.getElementById(\"symbolInput\").value||\"NQ\";console.log(`Using symbol: ${f}`);let v=f.replace(/[A-Z]\\d+$/,\"\");console.log(`Root symbol: ${v}`);let o=z[v];v!==F.lastRootSymbol&&(document.getElementById(\"tickInput\").value=o?.tickSize??\"\"),F.lastRootSymbol=v;let s=o&&typeof o.tickSize==\"number\"?o.tickSize:parseFloat(document.getElementById(\"tickInput\").value)||a;tickInput.value=s,localStorage.setItem(\"bracketTrade_tick\",s);let m=b||o?.defaultSL||parseInt(document.getElementById(\"slInput\").value)||40,r=c||o?.defaultTP||parseInt(document.getElementById(\"tpInput\").value)||100,B=o?.tickSize?\"dictionary\":document.getElementById(\"tickInput\").value?\"input field\":\"default parameter\";console.log(`Using tick size ${s} (from ${B})`),console.log(`Using SL: ${m} ticks, TP: ${r} ticks`),console.log(`Getting market data for ${f}`);let w=oe(f);if(!w){console.error(`No market data for ${f}`);return}console.log(\"Market data:\",w);let y=document.getElementById(\"entryPriceInput\"),T=y&&y.value?parseFloat(y.value):null,C=parseFloat(l===\"Buy\"?w.offerPrice:w.bidPrice);console.log(`Market price: ${C} (${l===\"Buy\"?\"offer\":\"bid\"} price)`);let A=\"MARKET\",_=C;T!==null?(console.log(`Custom entry price provided: ${T}`),_=T,l===\"Buy\"?A=T<C?\"LIMIT\":\"STOP\":A=T>C?\"LIMIT\":\"STOP\",console.log(`Order type determined to be: ${A}`)):console.log(`No custom entry price provided, using market order at ${C}`);let P=o?.precision??2;console.log(`Using price precision: ${P} decimal places`);let V=document.getElementById(\"slPriceInput\"),X=document.getElementById(\"tpPriceInput\"),t=V&&V.value?parseFloat(V.value):null,d=X&&X.value?parseFloat(X.value):null,i;t!==null?(i=t.toFixed(P),console.log(`Using hardcoded SL price: ${i}`)):(i=(l===\"Buy\"?_-m*s:_+m*s).toFixed(P),console.log(`Calculated SL price: ${i} (${l===\"Buy\"?\"entry - \":\"entry + \"}${m} ticks)`));let p;d!==null?(p=d.toFixed(P),console.log(`Using hardcoded TP price: ${p}`)):(p=(l===\"Buy\"?_+r*s:_-r*s).toFixed(P),console.log(`Calculated TP price: ${p} (${l===\"Buy\"?\"entry + \":\"entry - \"}${r} ticks)`));let x={symbol:w.symbol,action:l,qty:n.toString(),takeProfit:p,stopLoss:i,orderType:A,entryPrice:A!==\"MARKET\"?_.toFixed(P):null};return console.log(\"Trade data prepared:\",x),console.log(\"Submitting bracket orders\"),W(x).finally(()=>{let D=z[v],O=document.getElementById(\"slInput\"),G=document.getElementById(\"tpInput\")})}function S(e){console.log(`getFrontQuarter called for root: \"${e}\"`);let{letter:n,yearDigit:l}=E();console.log(`Got quarterly code: letter=${n}, yearDigit=${l}`);let c=`${e.toUpperCase()}${n}${l}`;return console.log(`Returning front quarter symbol: \"${c}\"`),c}function oe(e){console.log(`getMarketData called for: \"${e}\"`);let n=/^[A-Z]{1,3}$/.test(e)?q(e):e.toUpperCase(),l=K(n);if(!l)return console.log(`Cannot Find ${e}`),null;let c=l.querySelectorAll(\".public_fixedDataTableCell_cellContent\"),b=c[4]?.textContent.trim(),a=c[5]?.textContent.trim();return{symbol:n,bidPrice:b,offerPrice:a}}function K(e){let n=/^[A-Z]{1,3}$/.test((e||\"\").trim()),l=n?null:f(e),c=n?f(e):null,b=document.querySelectorAll(\".quoteboard.module.data-table, .data-table, .quoteboard\"),a=b.length?b:[document];for(let v of a){let o=v.querySelectorAll(\".public_fixedDataTable_bodyRow\");for(let s of o){if(s.offsetParent===null)continue;let m=s.querySelector(\".public_fixedDataTableCell_cellContent\");if(!m)continue;let r=f(m.textContent);if(l&&r===l||c&&r.startsWith(c))return s}}return console.error(`findQuoteRow: row for \"${e}\" not found (visible area).`),null;function f(v){return String(v||\"\").replace(/[\\u2000-\\u200F\\u2028\\u2029\\u202F\\u00A0]/g,\" \").replace(/\\s+/g,\" \").trim().toUpperCase()}}let Y=[\"F\",\"G\",\"H\",\"J\",\"K\",\"M\",\"N\",\"Q\",\"U\",\"V\",\"X\",\"Z\"];function ne(e=new Date){console.log(`getMonthlyCode called with date: ${e.toISOString()}`);let n=Y[e.getUTCMonth()],l=e.getUTCFullYear()%10+\"\";return console.log(`Calculated monthly code: letter=${n}, yearDigit=${l}`),{letter:n,yearDigit:l}}function H(e=new Date){console.log(`getNQFrontMonth called with date: ${e.toISOString()}`);let n=[3,6,9,12],l=[\"H\",\"M\",\"U\",\"Z\"],c=e.getFullYear(),b=e.getMonth()+1,a=e.getDate();console.log(`Current date: ${c}-${b}-${a}`);for(let o=0;o<n.length;o++){let s=n[o],m=j(c,s),r=new Date(m);if(r.setDate(m.getDate()-4),console.log(`Checking ${l[o]} contract: expiry=${m.toISOString()}, roll=${r.toISOString()}`),e<r){let B=`NQ${l[o]}${String(c).slice(-2)}`;return console.log(`Current front month: ${B} (before roll date)`),{symbol:B,letter:l[o],yearDigit:String(c).slice(-2),expiry:m,rollDate:r,isRollPeriod:!1}}else if(e<m){let B=(o+1)%4,w=B>o?c:c+1,y=`NQ${l[B]}${String(w).slice(-2)}`;return console.log(`Front month during roll period: ${y}`),{symbol:y,letter:l[B],yearDigit:String(w).slice(-2),expiry:j(w,n[B]),rollDate:r,isRollPeriod:!0}}}let f=c+1,v=`NQ${l[0]}${String(f).slice(-2)}`;return console.log(`Moving to next year: ${v}`),{symbol:v,letter:l[0],yearDigit:String(f).slice(-2),expiry:j(f,n[0]),rollDate:null,isRollPeriod:!1}}function j(e,n){let c=(5-new Date(e,n-1,1).getDay()+7)%7,b=new Date(e,n-1,1+c),a=new Date(b);return a.setDate(b.getDate()+14),a}function E(e=new Date){console.log(`getQuarterlyCode called (legacy) with date: ${e.toISOString()}`);let n=H(e);return console.log(`Legacy getQuarterlyCode returning: letter=${n.letter}, yearDigit=${n.yearDigit}`),{letter:n.letter,yearDigit:String(n.yearDigit).slice(-1)}}console.log(\"Calculating current NQ front month using CME rules...\");let $=H();console.log(`Current NQ front month: ${$.symbol}`),console.log(`Expiry date: ${$.expiry.toISOString()}`),console.log(`Roll date: ${$.rollDate?$.rollDate.toISOString():\"N/A\"}`),console.log(`Is in roll period: ${$.isRollPeriod}`);let{letter:Z,yearDigit:g}=E(),u=`NQ${Z}${g}`;console.log(`Legacy front-quarter symbol: ${u}`),window.getNQFrontMonth=H,window.getThirdFriday=j;let M={init:()=>{console.log(\"[TradoAuto] legacy driver init\")},autoTrade:F,clickExitForSymbol:N,moveStopLossToBreakeven,createUI:I,getNQFrontMonth:H,getThirdFriday:j},R=typeof unsafeWindow<\"u\"?unsafeWindow:window;window.TradoAuto=M,R.TradoAuto=M,R.TradovateAutoDriverBundle={default:M,autoTrade:F,clickExitForSymbol:N,moveStopLossToBreakeven,createUI:I,getNQFrontMonth:H,getThirdFriday:j},R.__tradoAutoInterval||(R.__tradoAutoInterval=setInterval(()=>{(!R.TradoAuto||typeof R.TradoAuto.autoTrade!=\"function\")&&(R.TradoAuto=M),(!window.TradoAuto||typeof window.TradoAuto.autoTrade!=\"function\")&&(window.TradoAuto=M)},250))})();var se=typeof window<\"u\"&&window.TradoAuto?window.TradoAuto:TradoAuto;function me(h,{visible:k=!1}={}){if(console.log(`Creating UI (visible=${k})`),!h)return console.warn(\"[TradoUIPanel] renderPanel called without driver instance\"),null;let I=h.state,N=h.futuresTickData,L=h.normalizeSymbol,U=\"NQ\",te=U.replace(/[A-Z]\\d+$/,\"\"),q=N[te]||N.NQ;I.symbol=U,I.tp=q.defaultTP,I.sl=q.defaultSL,I.tickSize=q.tickSize;let W=q.defaultTP.toString(),J=q.defaultSL.toString(),z=\"10\",F=q.tickSize.toString();console.log(`Using defaults: TP=${W}, SL=${J}, Qty=${z}, Tick=${F}, Symbol=${U}`),console.log(`Symbol data for ${te}: defaultTP=${q.defaultTP}, defaultSL=${q.defaultSL}`);let S=document.createElement(\"div\");S.id=k?\"bracket-trade-box\":\"invisible-trade-inputs\",k?(Object.assign(S.style,{position:\"fixed\",background:\"#1e1e1e\",border:\"1px solid #444\",padding:\"12px\",zIndex:\"99999\",boxShadow:\"0 2px 10px rgba(0,0,0,0.5)\",borderRadius:\"8px\",color:\"#fff\",cursor:\"move\",fontFamily:\"sans-serif\",textAlign:\"center\",width:\"200px\"}),S.style.top=\"20px\",S.style.right=\"20px\"):Object.assign(S.style,{position:\"fixed\",top:\"-9999px\",left:\"-9999px\",visibility:\"hidden\",opacity:\"0\",pointerEvents:\"none\"}),k?S.innerHTML=`\n        <!-- Header with Symbol -->\n        <div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;\">\n            <span style=\"font-weight:bold;cursor:grab;\">\\u283F Bracket</span>\n            <input type=\"text\" id=\"symbolInput\" value=\"${U}\"\n                style=\"width:50%;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\" \n                placeholder=\"Symbol\" />\n        </div>\n        \n        <!-- Hidden Tick Size Input -->\n        <div id=\"tickContainer\" style=\"display:none;margin-bottom:8px;\">\n            <label style=\"display:block;margin-bottom:4px;font-size:11px;\">Tick Size</label>\n            <input type=\"number\" id=\"tickInput\" step=\"0.01\" value=\"${F}\"\n                style=\"width:100%;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\" />\n        </div>\n\n        <!-- Main Controls -->\n        <div id=\"mainControls\">\n            <div style=\"display:flex;align-items:center;gap:8px;margin-bottom:8px;\">\n                <input type=\"checkbox\" id=\"tpCheckbox\" checked />\n                <div style=\"display:flex;gap:4px;flex:1;\">\n                    <input type=\"number\" id=\"tpInput\" value=\"${W}\"\n                        style=\"width:50%;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\"\n                        placeholder=\"TP Ticks\" />\n                    <input type=\"number\" id=\"tpPriceInput\" step=\"0.01\"\n                        style=\"width:50%;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\"\n                        placeholder=\"TP Price\" />\n                </div>\n            </div>\n            <div style=\"display:flex;align-items:center;gap:8px;margin-bottom:12px;\">\n                <input type=\"checkbox\" id=\"slCheckbox\" checked />\n                <div style=\"display:flex;gap:4px;flex:1;\">\n                    <input type=\"number\" id=\"slInput\" value=\"${J}\"\n                        style=\"width:50%;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\"\n                        placeholder=\"SL Ticks\" />\n                    <input type=\"number\" id=\"slPriceInput\" step=\"0.01\"\n                        style=\"width:50%;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\" \n                        placeholder=\"SL Price\" />\n                </div>\n            </div>\n            <div style=\"display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:12px;\">\n                <button id=\"buyBtn\"  style=\"padding:6px 10px;background:#2ecc71;color:#fff;border:none;border-radius:4px;font-weight:bold;\">Buy</button>\n                <div style=\"display:flex;flex-direction:column;gap:4px;\">\n                    <input type=\"number\" id=\"entryPriceInput\" placeholder=\"Entry\" step=\"0.01\"\n                        style=\"width:80px;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\" />\n                    <input type=\"number\" id=\"qtyInput\" value=\"${z}\" min=\"1\"\n                        style=\"width:80px;text-align:center;border-radius:4px;border:1px solid #666;background:#2a2a2a;color:#fff;\" />\n                </div>\n                <button id=\"sellBtn\" style=\"padding:6px 10px;background:#e74c3c;color:#fff;border:none;border-radius:4px;font-weight:bold;\">Sell</button>\n            </div>\n            <div style=\"display:flex;gap:10px;margin-bottom:2px;\">\n                <button id=\"cancelAllBtn\" style=\"flex:1;padding:12px 8px;background:#e6b800;color:#000;border:none;border-radius:4px;font-weight:bold;\">Cancel</button>\n                <button id=\"closeAllBtn\" style=\"flex:3;padding:12px 8px;background:#e74c3c;color:#fff;border:none;border-radius:4px;font-weight:bold;\">Close All</button>\n            </div>\n            <!-- NEW: Breakeven button above Reverse -->\n            <div style=\"display:flex;gap:10px;margin-top:6px;\">\n                <button id=\"breakevenBtn\" style=\"flex:1;padding:12px 8px;background:#6c5ce7;color:#fff;border:none;border-radius:4px;font-weight:bold;\">Breakeven</button>\n            </div>\n            <div style=\"display:flex;gap:10px;margin-top:6px;\">\n                <button id=\"reverseBtn\" style=\"flex:1;padding:12px 8px;background:#ff6600;color:#fff;border:none;border-radius:4px;font-weight:bold;\">Reverse</button>\n            </div>\n        </div>`:S.innerHTML=`\n            <input type=\"text\" id=\"symbolInput\" value=\"${U}\" />\n            <input type=\"number\" id=\"tickInput\" value=\"${F}\" />\n            <input type=\"number\" id=\"tpInput\" value=\"${W}\" />\n            <input type=\"number\" id=\"slInput\" value=\"${J}\" />\n            <input type=\"number\" id=\"qtyInput\" value=\"${z}\" />\n            <input type=\"number\" id=\"entryPriceInput\" />\n            <input type=\"number\" id=\"tpPriceInput\" />\n            <input type=\"number\" id=\"slPriceInput\" />\n            <input type=\"checkbox\" id=\"tpCheckbox\" checked />\n            <input type=\"checkbox\" id=\"slCheckbox\" checked />\n        `;let oe=k?\"bracket-trade-box\":\"invisible-trade-inputs\";if(document.getElementById(oe))return console.log(`${oe} already exists, skipping creation`),document.getElementById(oe);document.body.appendChild(S),console.log(\"UI container added to DOM\"),console.log(\"Setting up universal event handlers\");let K=document.getElementById(\"slInput\"),Y=document.getElementById(\"tpInput\"),ne=document.getElementById(\"qtyInput\");K&&K.addEventListener(\"input\",()=>{console.log(`SL input changed to: ${K.value}`);let E=parseFloat(K.value);isNaN(E)||(I.sl=E,Y&&(Y.value=Math.round(E*3.5)),I.tp=Math.round(E*3.5),console.log(`Calculated TP: ${I.tp} (SL \\xD7 3.5)`))}),Y&&Y.addEventListener(\"input\",()=>{console.log(`TP input changed to: ${Y.value}`);let E=parseFloat(Y.value);isNaN(E)||(I.tp=E)}),ne&&ne.addEventListener(\"input\",E=>{console.log(`Quantity input changed to: ${E.target.value}`);let $=parseInt(E.target.value);!isNaN($)&&$>0&&(I.qty=$)});let H=document.getElementById(\"symbolInput\");H&&(H.addEventListener(\"input\",E=>{console.log(`Symbol input changed to: ${E.target.value}`),I.symbol=E.target.value}),H.addEventListener(\"change\",E=>{let $=E.target.value,Z=L($);console.log(`Symbol changed to: ${$}, normalized: ${Z}`);let g=$.replace(/[A-Z]\\d+$/,\"\"),u=N[g];if(u){console.log(`Found default values for ${g}: SL=${u.defaultSL}, TP=${u.defaultTP}`);let M=document.getElementById(\"slInput\"),R=document.getElementById(\"tpInput\"),e=document.getElementById(\"tickInput\");M.value=u.defaultSL,R.value=u.defaultTP,I.sl=u.defaultSL,I.tp=u.defaultTP,typeof u.tickSize==\"number\"&&(e.value=u.tickSize,I.tickSize=u.tickSize,console.log(`Updated tick size to ${u.tickSize} for ${g}`)),console.log(`\\u2705 Updated SL/TP to default values for ${g}: SL=${M.value}, TP=${R.value}`)}h.updateSymbol(\".trading-ticket .search-box--input\",Z)}));let j=document.getElementById(\"tickInput\");if(j&&j.addEventListener(\"input\",E=>{console.log(`Tick size input changed to: ${E.target.value}`);let $=parseFloat(E.target.value);!isNaN($)&&$>0&&(I.tickSize=$)}),k){console.log(\"Setting up UI event handlers\"),document.getElementById(\"closeAllBtn\").addEventListener(\"click\",()=>{console.log(\"Close All button clicked\");try{let g=document.getElementById(\"symbolInput\").value||\"NQ\",u=L(g);console.log(`Calling clickExitForSymbol for: ${u} with Exit at Mkt & Cxl option`),h.clickExitForSymbol(u,\"cancel-option-Exit-at-Mkt-Cxl\"),console.log(\"Exit action triggered for symbol:\",u)}catch(g){console.error(\"Close All operation failed:\",g);try{console.log(\"Attempting fallback close method with danger buttons\"),document.getElementsByClassName(\"btn btn-danger\")[0]?.click(),setTimeout(()=>{document.getElementsByClassName(\"btn btn-danger\")[1]?.click(),document.getElementsByClassName(\"btn btn-danger\")[2]?.click()},200)}catch(u){console.error(\"Fallback close method also failed:\",u)}}}),document.getElementById(\"cancelAllBtn\").addEventListener(\"click\",()=>{console.log(\"Cancel All button clicked\");try{let g=document.getElementById(\"symbolInput\").value||\"NQ\",u=L(g);console.log(`Calling clickExitForSymbol for: ${u} with Cancel All option`),h.clickExitForSymbol(u,\"cancel-option-Cancel-All\"),console.log(\"Cancel All action triggered for symbol:\",u)}catch(g){console.error(\"Cancel All operation failed:\",g)}}),document.getElementById(\"reverseBtn\").addEventListener(\"click\",()=>{console.log(\"Reverse Position button clicked\");try{let g=document.getElementById(\"symbolInput\").value||\"NQ\",u=L(g);console.log(`Calling clickExitForSymbol for: ${u} with Reverse & Cxl option`),h.clickExitForSymbol(u,\"cancel-option-Reverse-Cxl\"),console.log(\"Reverse Position action triggered for symbol:\",u)}catch(g){console.error(\"Reverse Position operation failed:\",g)}}),document.getElementById(\"breakevenBtn\").addEventListener(\"click\",()=>{console.log(\"Breakeven button clicked\");try{let g=document.getElementById(\"symbolInput\").value||\"NQ\",u=L(g);console.log(`Processing breakeven for symbol: ${u}`),h.moveStopLossToBreakeven(u),console.log(\"Breakeven action triggered for symbol:\",u)}catch(g){console.error(\"Breakeven operation failed:\",g)}}),console.log(\"Setting up default values\"),document.getElementById(\"symbolInput\").value=\"NQ\",document.getElementById(\"tickInput\").value=I.tickSize,console.log(\"Setting up drag functionality\");let E=!1,$,Z;S.addEventListener(\"mousedown\",g=>{console.log(\"Container mousedown event detected\"),E=!0,$=g.clientX-S.getBoundingClientRect().left,Z=g.clientY-S.getBoundingClientRect().top,console.log(`Drag started at offset X:${$}, Y:${Z}`),S.style.cursor=\"grabbing\"}),document.addEventListener(\"mousemove\",g=>{if(E){let u=`${g.clientX-$}px`,M=`${g.clientY-Z}px`;g.clientX%20===0&&console.log(`Dragging panel to X:${u}, Y:${M}`),S.style.left=u,S.style.top=M,S.style.right=\"unset\"}}),document.addEventListener(\"mouseup\",()=>{E&&console.log(`Container drop position: Left:${S.style.left}, Top:${S.style.top}`),E=!1,S.style.cursor=\"grab\"}),console.log(\"Setting up trade buttons\"),document.getElementById(\"buyBtn\").addEventListener(\"click\",()=>{console.log(\"BUY button clicked\");let g=document.getElementById(\"symbolInput\").value||\"NQ\",u=+ne.value,M=+Y.value,R=+K.value,e=+document.getElementById(\"tickInput\").value;console.log(`Initiating BUY order: Symbol=${g}, Qty=${u}, TP=${M}, SL=${R}, TickSize=${e}`),h.autoTrade(g,u,\"Buy\",M,R,e).finally(()=>{document.getElementById(\"entryPriceInput\").value=\"\",document.getElementById(\"tpPriceInput\").value=\"\",document.getElementById(\"slPriceInput\").value=\"\",console.log(\"Price inputs reset after BUY order\")})}),document.getElementById(\"sellBtn\").addEventListener(\"click\",()=>{console.log(\"SELL button clicked\");let g=document.getElementById(\"symbolInput\").value||\"NQ\",u=+ne.value,M=+Y.value,R=+K.value,e=+document.getElementById(\"tickInput\").value;console.log(`Initiating SELL order: Symbol=${g}, Qty=${u}, TP=${M}, SL=${R}, TickSize=${e}`),h.autoTrade(g,u,\"Sell\",M,R,e).finally(()=>{document.getElementById(\"entryPriceInput\").value=\"\",document.getElementById(\"tpPriceInput\").value=\"\",document.getElementById(\"slPriceInput\").value=\"\",console.log(\"Price inputs reset after SELL order\")})})}return console.log(\"State management: Using in-memory state only, no persistence\"),S}function be({driverInstance:h=se}={},k={}){let I=!1,N=!1,L=null;function U(z={}){let{visible:F=!0}={...k,...z},S=me(h,{visible:F});return S&&(I=!0,N=F,L=S),S}function te(){return U({visible:!1})}function q(){return U({visible:!0})}function W(){let z=!1,F=document.getElementById(\"bracket-trade-box\"),S=document.getElementById(\"invisible-trade-inputs\");return F&&(F.remove(),z=!0),S&&(S.remove(),z=!0),z&&(I=!1,N=!1,L=null),z}function J(){return{mounted:I,visible:N,hasPanel:!!document.getElementById(\"bracket-trade-box\"),hasInvisiblePanel:!!document.getElementById(\"invisible-trade-inputs\"),lastContainer:L}}return{mount:U,createUI:U,createInvisibleUI:te,show:q,hide:W,getStatus:J,render:z=>me(h,z)}}var de=be();se.registerUIPanel(de);typeof window<\"u\"&&(window.TradoUIPanel=de);var Be=de;return $e(Te);})();\n//# sourceMappingURL=tradovate_ui_panel.js.map\n";

    function inject(code, id) {
        if (!code) {
            console.warn(`[AutoOrder] No code supplied for ${id}, skipping injection.`);
            return;
        }

        const scriptId = `trado-${id}`;
        if (document.getElementById(scriptId)) {
            console.debug(`[AutoOrder] Script ${scriptId} already present, skipping duplicate injection.`);
            return;
        }

        const script = document.createElement('script');
        script.id = scriptId;
        script.type = 'text/javascript';
        script.textContent = code;
        document.head.appendChild(script);
        console.debug(`[AutoOrder] Injected ${id} bundle.`);
    }

    function waitForGlobal(name, timeout = 8000) {
        return new Promise((resolve, reject) => {
            const start = Date.now();
            (function check() {
                if (window[name]) {
                    resolve(window[name]);
                    return;
                }
                if (Date.now() - start > timeout) {
                    reject(new Error(`${name} not available within ${timeout}ms`));
                    return;
                }
                requestAnimationFrame(check);
            })();
        });
    }

    inject(driverSource, 'auto-driver');
    inject(panelSource, 'ui-panel');

    Promise.all([
        waitForGlobal('TradoAuto'),
        waitForGlobal('TradoUIPanel')
    ]).then(([autoDriver, uiPanel]) => {
        try {
            autoDriver.init?.({ source: 'tampermonkey' });
        } catch (err) {
            console.error('[AutoOrder] Failed to init driver', err);
        }

        try {
            uiPanel.mount?.({ visible: true });
        } catch (err) {
            console.error('[AutoOrder] Failed to mount UI panel', err);
        }

        console.info('[AutoOrder] Driver and panel ready.');
    }).catch(err => {
        console.error('[AutoOrder] Initialization failed', err);
    });
})();
